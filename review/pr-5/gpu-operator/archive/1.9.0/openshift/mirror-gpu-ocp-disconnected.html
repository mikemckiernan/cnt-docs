<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deploy GPU Operators in a disconnected or airgapped environment &mdash; NVIDIA Cloud Native Technologies  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../../_static/nvidia.ico"/>
    <link rel="canonical" href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/archive/1.9.0/openshift/mirror-gpu-ocp-disconnected.html"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script src="../../../../_static/js/google-analytics/google-analytics-tracker.js"></script>
        <script src="../../../../_static/js/google-analytics/google-analytics-write.js"></script>
        <script src="//assets.adobedtm.com/b92787824f2e0e9b68dc2e993f9bd995339fe417/satelliteLib-7ba51e58dc61bcb0e9311aadd02a0108ab24cc6c.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Troubleshooting" href="troubleshooting-gpu-ocp.html" />
    <link rel="prev" title="Cleanup" href="clean-up.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" > 
            <a href="../../../../contents.html">
            <img src="../../../../_static/NVLogo_H_B&W.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #76b900;
    }

    .wy-side-nav-search a:link, .wy-nav-top a:link {
      color: #fff;
    }
    .wy-side-nav-search a:visited, .wy-nav-top a:visited {
      color: #fff;
    }
    .wy-side-nav-search a:hover, .wy-nav-top a:hover {
      color: #fff;
    }

    .wy-menu-vertical a:link, .wy-menu-vertical a:visited {
      color: #d9d9d9
    }

    .wy-menu-vertical a:active {
      background-color: #76b900
    }

    .wy-side-nav-search>div.version {
      color: rgba(0, 0, 0, 0.3)
    }

    .wy-nav-content {
      max-width: 1000px;
    }
  </style>
  
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">NVIDIA Container Toolkit:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../container-toolkit/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../container-toolkit/concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../container-toolkit/arch-overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../container-toolkit/install-guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../container-toolkit/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../container-toolkit/user-guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../container-toolkit/release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../container-toolkit/archive.html">Archive</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">NVIDIA GPU Operator:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../platform-support.html">Platform Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu-driver-upgrades.html">GPU Driver Upgrades</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install-gpu-operator-vgpu.html">NVIDIA vGPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install-gpu-operator-nvaie.html">NVIDIA AI Enterprise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openshift/contents.html">GPU Operator on OpenShift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu-operator-mig.html">GPU Operator with MIG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu-sharing.html">Time-Slicing GPUs in Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu-operator-rdma.html">GPUDirect RDMA and GPUDirect Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu-operator-kubevirt.html">GPU Operator with KubeVirt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix.html">Appendix</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../archive.html">Archive</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../archive.html#id1">22.9.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../archive.html#id2">22.9.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../archive.html#id3">1.11.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../archive.html#id4">1.11.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../archive.html#id5">1.10.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../archive.html#id6">1.9.1</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../archive.html#id7">1.9.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../archive.html#id8">1.8</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Kubernetes with GPUs:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../kubernetes/install-k8s.html">Install Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kubernetes/mig-k8s.html">MIG Support in Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kubernetes/anthos-guide.html">NVIDIA GPUs with Google Cloud’s Anthos</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GPU Telemetry:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../gpu-telemetry/dcgm-exporter.html">DCGM-Exporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gpu-telemetry/dcgm-exporter.html#integrating-gpu-telemetry-into-kubernetes">Integrating GPU Telemetry into Kubernetes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Multi-Instance GPU:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../mig/mig.html">Multi-Instance GPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mig/mig-k8s.html">MIG Support in Kubernetes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Driver Containers:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../driver-containers/overview.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Playground:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../playground/dind.html">Docker-in-Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../playground/x-arch.html">Running Cross-Architecture Containers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../contents.html">NVIDIA Cloud Native Technologies</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../contents.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../archive.html">Archive</a> &raquo;</li>
          <li><a href="contents.html">GPU Operator on OpenShift</a> &raquo;</li>
      <li>Deploy GPU Operators in a disconnected or airgapped environment</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="deploy-gpu-operators-in-a-disconnected-or-airgapped-environment">
<span id="mirror-gpu-ocp-disconnected-1-9-0"></span><h1>Deploy GPU Operators in a disconnected or airgapped environment<a class="headerlink" href="#deploy-gpu-operators-in-a-disconnected-or-airgapped-environment" title="Permalink to this heading"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>This page describes how to successfully deploy the <strong>NVIDIA GPU Operator</strong> on a Openshift Container Platform cluster in a disconnected or airgapped environment.</p>
<p>For an OpenShift Container Platform cluster that is installed on a disconnected cluster, the Operator Lifecycle Manager (OLM) by default cannot access the Red Hat-provided OperatorHub sources hosted on remote registries because those remote sources require full Internet connectivity.</p>
<p>However, as a cluster administrator you can still enable your cluster to use the OLM in a disconnected network if you have a workstation that has full Internet access. The workstation, which requires full Internet access to pull the remote OperatorHub content, is used to prepare local mirrors of the remote sources, and push the content to a mirror registry.</p>
<p>This workstation for the purposes of the remainder of this document is referred to as the <cite>jump host</cite>. The mirror registry for the purposes of this illustrated example is located on the <cite>jump host</cite>, with connectivity to both your internet and the disconnected cluster.</p>
<p>In a completely disconnected (airgapped) environment a second <cite>jump host</cite> is needed. In this environment you need to:</p>
<ol class="arabic simple">
<li><p>Fetch all the resources on a removable disk</p></li>
<li><p>Move the disk to a second jump host</p></li>
<li><p>Set up the services from the second jump host</p></li>
</ol>
<p>This guide describes how to prune the Operator catalog to the subset that enables the installation of the <strong>NVIDIA GPU Operator</strong> in a disconnected environment.</p>
<p>The <a class="reference external" href="https://docs.openshift.com/container-platform/latest/operators/admin/olm-restricted-networks.html">OpenShift Container Platform documentation</a> provides generic guidance on using Operator Lifecycle Manager on restricted networks.</p>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading"></a></h2>
<ul>
<li><p>A working OpenShift cluster up and running with a GPU worker node. See, <a class="reference external" href="https://docs.openshift.com/container-platform/latest/installing/installing-mirroring-installation-images.html">OpenShift Container Platform installation</a> for guidance on installing OpenShift Container Platform.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If installing the <strong>NVIDIA GPU Operator</strong> on OpenShift Container Platform version &lt;<code class="docutils literal notranslate"><span class="pre">4.9.9</span></code> you need to carry out the steps highlighted as <strong>Optional</strong> below. For more information see <a class="reference internal" href="steps-overview.html#broken-dtk-1-9-0"><span class="std std-ref">broken driver toolkit</span></a>.</p>
</div>
</li>
<li><p>Access to the cluster as a user with the <code class="docutils literal notranslate"><span class="pre">cluster-admin</span></code> role.</p></li>
<li><p>Access to a registry that supports <a class="reference external" href="https://docs.docker.com/registry/spec/manifest-v2-2/">Docker v2-2</a>. A private registry <strong>must</strong> be configured on the jump host. This can be one of the following registries:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.redhat.com/en/technologies/cloud-computing/quay">Red Hat Quay</a></p></li>
<li><p><a class="reference external" href="https://jfrog.com/artifactory/">JFrog Artifactory</a></p></li>
<li><p><a class="reference external" href="https://www.sonatype.com/products/repository-oss?topnav=true">Sonatype Nexus Repository</a></p></li>
<li><p><a class="reference external" href="https://goharbor.io/">Harbor</a></p></li>
</ul>
<p>Create a private registry using <code class="docutils literal notranslate"><span class="pre">podman</span></code> and guidance on this can be found <a class="reference external" href="https://www.redhat.com/sysadmin/simple-container-registry">here</a> and in the section <a class="reference internal" href="../../../openshift/mirror-gpu-ocp-disconnected.html#creating-a-private-registry"><span class="std std-ref">Creating a private registry</span></a>.</p>
<p>If you have an entitlement to Red Hat Quay, see the documentation on deploying Red Hat Quay for <a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.5/html/deploy_red_hat_quay_for_proof-of-concept_non-production_purposes/">proof-of-concept purposes</a> or by using the <a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_quay/3.5/html/deploy_red_hat_quay_on_openshift_with_the_quay_operator/">Quay Operator</a>. If you need additional assistance selecting and installing a registry, contact your sales representative or Red Hat support. For more information, see <a class="reference external" href="https://docs.openshift.com/container-platform/latest/installing/installing-mirroring-installation-images.html#installation-about-mirror-registry_installing-mirroring-installation-images">about the mirror registry</a>.</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>When creating a self-signed certificate and if you enable HTTPS for the local registry, ensure you have appended <code class="docutils literal notranslate"><span class="pre">-addext</span> <span class="pre">&quot;subjectAltName=DNS:${JUMP_HOST}&quot;</span></code> to your <code class="docutils literal notranslate"><span class="pre">openssl</span></code> command, otherwise OpenShift Container Platform cannot pull images from the private registry.</p>
<p>If you do not set a Subject Alternative Name, before running the <code class="docutils literal notranslate"><span class="pre">oc</span></code> commands in the subsequent sections export the environment variable <code class="docutils literal notranslate"><span class="pre">GODEBUG=x509ignoreCN=0</span></code>. If you do not set this variable, the <code class="docutils literal notranslate"><span class="pre">oc</span></code> commands will fail with the following error:</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>x509:<span class="w"> </span>certificate<span class="w"> </span>relies<span class="w"> </span>on<span class="w"> </span>legacy<span class="w"> </span>Common<span class="w"> </span>Name<span class="w"> </span>field,<span class="w"> </span>use<span class="w"> </span>SANs<span class="w"> </span>or<span class="w"> </span>temporarily<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>Common<span class="w"> </span>Name<span class="w"> </span>matching<span class="w"> </span>with<span class="w"> </span><span class="sb">``</span><span class="nv">GODEBUG</span><span class="o">=</span><span class="nv">x509ignoreCN</span><span class="o">=</span><span class="m">0</span><span class="sb">``</span>.
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you use HTTP, in Openshift Container Platform add <code class="docutils literal notranslate"><span class="pre">insecureRegistries</span></code> to <code class="docutils literal notranslate"><span class="pre">image.config.openshift.io/cluster</span></code>. Guidance on that configuration is provided <a class="reference external" href="https://docs.openshift.com/container-platform/latest/openshift_images/image-configuration.html">here</a>.</p>
</div>
</div></blockquote>
</li>
</ul>
<p><strong>On the jump host:</strong></p>
<ul class="simple">
<li><p><strong>Optional</strong>: Install <code class="docutils literal notranslate"><span class="pre">yum-utils</span></code>. This provides the <code class="docutils literal notranslate"><span class="pre">reposync</span></code> script and is <strong>only</strong> required if installing the <strong>NVIDIA GPU Operator</strong> on OpenShift Container Platform version <code class="docutils literal notranslate"><span class="pre">4.8.19</span></code>, <code class="docutils literal notranslate"><span class="pre">4.8.21</span></code> or <code class="docutils literal notranslate"><span class="pre">4.9.8</span></code>.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">yum-utils</span></code> is required for the package mirror while the remaining prerequisites (listed below) are required for the image mirroring.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">podman</span></code> version 1.9.3+</p></li>
<li><p><a class="reference external" href="https://github.com/fullstorydev/grpcurl">grpcurl</a></p></li>
<li><p>Install the OpenShift CLI (<code class="docutils literal notranslate"><span class="pre">oc</span></code>).</p></li>
<li><p>Red Hat Enterprise Linux (RHEL) on your jump host. The jump host when configured becomes the private registry host.</p></li>
<li><p>Install the <code class="docutils literal notranslate"><span class="pre">opm</span></code> CLI (opm version 1.12.3+) used to prune the default catalog. Guidance on downloading this tool is <a class="reference external" href="https://docs.openshift.com/container-platform/latest/cli_reference/opm-cli.html">here</a>.</p></li>
</ul>
</section>
<section id="set-up-a-basic-http-server">
<h2>Set up a basic HTTP Server<a class="headerlink" href="#set-up-a-basic-http-server" title="Permalink to this heading"></a></h2>
<p>Image mirroring require a simple HTTP server, follow the guidance below to setup a basic web server:</p>
<ol class="arabic">
<li><p>Install Apache <code class="docutils literal notranslate"><span class="pre">httpd</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>yum<span class="w"> </span>install<span class="w"> </span>httpd<span class="w"> </span>-y
</pre></div>
</div>
</li>
<li><p>Start the Apache web server for the first time:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>systemctl<span class="w"> </span>restart<span class="w"> </span>httpd
</pre></div>
</div>
</li>
<li><p>Enable the Apache web server to start automatically at system boot:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>httpd
</pre></div>
</div>
</li>
<li><p>Open port 80 and 443 to allow web traffic to the Apache web server service, update the system firewall rules allowing inbound packets on HTTP and HTTPS using the commands below:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>firewall-cmd<span class="w"> </span>--zone<span class="o">=</span>public<span class="w"> </span>--permanent<span class="w"> </span>--add-service<span class="o">=</span>http
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>firewall-cmd<span class="w"> </span>--zone<span class="o">=</span>public<span class="w"> </span>--permanent<span class="w"> </span>--add-service<span class="o">=</span>https
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>firewall-cmd<span class="w"> </span>--reload
</pre></div>
</div>
</li>
</ol>
</section>
<section id="optional-check-the-version-of-rhel-being-used-in-the-cluster">
<h2>Optional: Check the version of RHEL being used in the cluster<a class="headerlink" href="#optional-check-the-version-of-rhel-being-used-in-the-cluster" title="Permalink to this heading"></a></h2>
<p>These steps only need to be carried out if installing the <strong>NVIDIA GPU Operator</strong> on OpenShift Container Platform version <code class="docutils literal notranslate"><span class="pre">4.8.19</span></code>, <code class="docutils literal notranslate"><span class="pre">4.8.21</span></code> or <code class="docutils literal notranslate"><span class="pre">4.9.8</span></code>.</p>
<p>Before mirroring the RPM packages check the version of RHEL being used in the cluster.</p>
<ol class="arabic">
<li><p>To determine the RHEL version running on the cluster use the OpenShift CLI and run the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>debug<span class="w">  </span><span class="k">$(</span>oc<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-oname<span class="w"> </span>-lnode-role.kubernetes.io/worker<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="k">)</span><span class="w"> </span>--<span class="w"> </span>cat<span class="w"> </span>/host/etc/os-release<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>RHEL
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Starting pod/openshift-worker-0openshiftpool2practiceredhatcom-debug ...</span>
<span class="go">To use host binaries, run `chroot /host`</span>
<span class="go">RHEL_VERSION=&quot;8.4&quot;</span>

<span class="go">Removing debug pod ...</span>
</pre></div>
</div>
</li>
</ol>
<p>This gives you the <code class="docutils literal notranslate"><span class="pre">releasever</span></code> to supply as a command line argument to <code class="docutils literal notranslate"><span class="pre">reposync</span></code>.</p>
<p>For guidance on logging in to the OpenShift CLI see, <a class="reference external" href="https://docs.openshift.com/container-platform/latest/cli_reference/openshift_cli/getting-started-cli.html">here</a>.</p>
</section>
<section id="optional-mirror-the-rpm-packages">
<h2>Optional: Mirror the RPM packages<a class="headerlink" href="#optional-mirror-the-rpm-packages" title="Permalink to this heading"></a></h2>
<p>These steps only need to be carried out if installing the <strong>NVIDIA GPU Operator</strong> on OpenShift Container Platform version <code class="docutils literal notranslate"><span class="pre">4.8.19</span></code>, <code class="docutils literal notranslate"><span class="pre">4.8.21</span></code> or <code class="docutils literal notranslate"><span class="pre">4.9.8</span></code>.</p>
<p>Follow the guidance below to sync the required <code class="docutils literal notranslate"><span class="pre">yum</span></code> repositories:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The size of the whole yum repository is huge, make sure there is enough space on your jump host. At least 50GB is required.</p>
</div>
<ol class="arabic">
<li><p>If you have access to the GPG public key, use the following command to manually import a key:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>rpm<span class="w"> </span>--import<span class="w"> </span>/etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
</pre></div>
</div>
</li>
<li><p>Create a directory to store the downloaded repos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/mirror-repos/
</pre></div>
</div>
</li>
<li><p>List all available repositories enabled for the system:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>subscription-manager<span class="w"> </span>repos<span class="w"> </span>--list-enabled
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">+----------------------------------------------------------+</span>
<span class="go">      Available Repositories in /etc/yum.repos.d/redhat.repo</span>
<span class="go">+----------------------------------------------------------+</span>
<span class="go">Repo ID:   rhel-8-for-x86_64-appstream-rpms</span>
<span class="go">Repo Name: Red Hat Enterprise Linux 8 for x86_64 - AppStream (RPMs)</span>
<span class="go">Repo URL:  https://cdn.redhat.com/content/dist/rhel8/$releasever/x86_64/appstream/os</span>
<span class="go">Enabled:   1</span>

<span class="go">Repo ID:   rhel-8-for-x86_64-baseos-rpms</span>
<span class="go">Repo Name: Red Hat Enterprise Linux 8 for x86_64 - BaseOS (RPMs)</span>
<span class="go">Repo URL:  https://cdn.redhat.com/content/dist/rhel8/$releasever/x86_64/baseos/os</span>
<span class="go">Enabled:   1</span>
</pre></div>
</div>
<p>This supplies you with the <code class="docutils literal notranslate"><span class="pre">repoid</span></code> you need in step 4 and 5.</p>
</li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">reposync</span></code> to synchronize the BaseOS repos to the locally created directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>reposync<span class="w"> </span>--gpgcheck<span class="w"> </span>--repoid<span class="o">=</span>rhel-8-for-x86_64-baseos-rpms<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--releasever<span class="o">=</span><span class="m">8</span>.4<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--download-path<span class="o">=</span>/opt/mirror-repos/<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--downloadcomps<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--download-metadata<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--nodocs
</pre></div>
</div>
</li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">reposync</span></code> to synchronize the AppStream repos to the locally created directory:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>reposync<span class="w"> </span>--gpgcheck<span class="w"> </span>--repoid<span class="o">=</span>rhel-8-for-x86_64-appstream-rpms<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>--releasever<span class="o">=</span><span class="m">8</span>.4<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>--download-path<span class="o">=</span>/opt/mirror-repos/<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>--downloadcomps<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>--download-metadata<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>--nodocs
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Create a directory to host and serve the AppStream RPM packages:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mkdir -p /var/www/html/content/dist/rhel8/8/x86_64/appstream/</span>
</pre></div>
</div>
</li>
<li><p>Create a directory to host and serve the BaseOS RPM packages:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/var/www/html/content/dist/rhel8/8/x86_64/baseos/
</pre></div>
</div>
</li>
<li><p>Create symbolic links between the downloaded repos and the document root directory on the jump host used to serve the RPMs.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ln<span class="w"> </span>-s<span class="w"> </span>/opt/mirror-repos/rhel-8-for-x86_64-baseos-rpms/<span class="w"> </span>/var/www/html/content/dist/rhel8/8/x86_64/baseos/os
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ln<span class="w"> </span>-s<span class="w"> </span>/opt/mirror-repos/rhel-8-for-x86_64-appstream-rpms<span class="w"> </span>/var/www/html/content/dist/rhel8/8/x86_64/appstream/os
</pre></div>
</div>
</li>
</ol>
</section>
<section id="creating-a-private-registry">
<h2>Creating a private registry<a class="headerlink" href="#creating-a-private-registry" title="Permalink to this heading"></a></h2>
<p>Create a private registry to host the mirrored content that you require for mirroring the Operator Catalog. The target registry must support <a class="reference external" href="https://docs.docker.com/registry/spec/manifest-v2-2/">Docker v2-2</a>. For a cluster on a restricted network, this registry can be one that the cluster has network access to.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Deploying a disconnected registry host based on the <code class="docutils literal notranslate"><span class="pre">docker.io/library/registry:2</span></code> API for is not officially supported by Red Hat. You can create a mirror host based on the <code class="docutils literal notranslate"><span class="pre">docker.io/library/registry:2</span></code> API with the following unsupported procedure.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The following procedure creates a simple registry that stores data in the <code class="docutils literal notranslate"><span class="pre">/opt/registry</span></code> folder and runs in a <code class="docutils literal notranslate"><span class="pre">podman</span></code> container. You can use a different
registry solution, such as <a class="reference external" href="https://docs.openshift.com/container-platform/latest/installing/installing-mirroring-installation-images.html">Red Hat Quay</a>.</p>
</div>
<p>Configure a private registry on the the jump host, using the following steps:</p>
<ol class="arabic">
<li><p>Install the required packages:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>yum<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>podman<span class="w"> </span>httpd<span class="w"> </span>httpd-tools
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">podman</span></code> package provides the container package that you run the registry in. The <code class="docutils literal notranslate"><span class="pre">httpd-tools</span></code> package provides the <code class="docutils literal notranslate"><span class="pre">htpasswd</span></code> utility, which you use to create users.</p>
</li>
<li><p>Create folders for the registry:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/registry/<span class="o">{</span>auth,certs,data<span class="o">}</span>
</pre></div>
</div>
<p>These folders are mounted inside the registry container.</p>
</li>
<li><p>Set the following environment variable:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">JUMP_HOST</span><span class="o">=</span>&lt;Your_jump_hostname&gt;
</pre></div>
</div>
</li>
<li><p>Provide a certificate for the registry. If you do not have an existing, trusted certificate authority, you can generate a self-signed certificate:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>/opt/registry/certs
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>req<span class="w"> </span>-addext<span class="w"> </span><span class="s2">&quot;subjectAltName=DNS:</span><span class="si">${</span><span class="nv">JUMP_HOST</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-newkey<span class="w"> </span>rsa:4096<span class="w"> </span>-nodes<span class="w"> </span>-sha256<span class="w"> </span>-keyout<span class="w"> </span>domain.key<span class="w"> </span>-x509<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span>-out<span class="w"> </span>domain.crt
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>OpenSSL version 1.1.1 or higher is required.</p>
</div>
<p>At the prompts, provide the required values for the certificate:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 35%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Country Name (2 letter code)</p></td>
<td><p>Specify the two-letter ISO country code for your location.
See the <a class="reference external" href="https://www.iso.org/iso-3166-country-codes.html">ISO 3166 country codes standard</a>.</p></td>
</tr>
<tr class="row-odd"><td><p>State or Province Name (full name)</p></td>
<td><p>Enter the full name of your state or province.</p></td>
</tr>
<tr class="row-even"><td><p>Locality Name (eg, city)</p></td>
<td><p>Enter the name of your city.</p></td>
</tr>
<tr class="row-odd"><td><p>Organization Name (eg, company)</p></td>
<td><p>Enter your company name.</p></td>
</tr>
<tr class="row-even"><td><p>Organizational Unit Name (eg, section)</p></td>
<td><p>Enter your department name.</p></td>
</tr>
<tr class="row-odd"><td><p>Common Name (eg, your name or your server’s hostname)</p></td>
<td><p>Enter the hostname for the registry host.
Ensure that your hostname is in DNS and that it resolves to the expected IP address.</p></td>
</tr>
<tr class="row-even"><td><p>Email Address</p></td>
<td><p>For more information, see the <a class="reference external" href="https://www.openssl.org/docs/man1.1.1/man1/req.html">req</a> description in the OpenSSL documentation.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p>Generate a <code class="docutils literal notranslate"><span class="pre">user</span> <span class="pre">name</span></code> and a <code class="docutils literal notranslate"><span class="pre">password</span></code> for your registry that uses the <code class="docutils literal notranslate"><span class="pre">bcrpt</span></code> format:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>htpasswd<span class="w"> </span>-bBc<span class="w"> </span>/opt/registry/auth/htpasswd<span class="w"> </span>&lt;user_name&gt;<span class="w"> </span>&lt;password&gt;
</pre></div>
</div>
<p>Replace <code class="docutils literal notranslate"><span class="pre">&lt;user_name&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;password&gt;</span></code> with a user name and a password.</p>
</li>
<li><p>Create the <cite>mirror-registry</cite> container to host your registry:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>podman<span class="w"> </span>run<span class="w"> </span>--name<span class="w"> </span>mirror-registry<span class="w"> </span>-p<span class="w"> </span><span class="nv">$JUMP_HOST_PORT</span>:5000<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-v<span class="w"> </span>/opt/registry/data:/var/lib/registry:z<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-v<span class="w"> </span>/opt/registry/auth:/auth:z<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-e<span class="w"> </span><span class="s2">&quot;REGISTRY_AUTH=htpasswd&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-e<span class="w"> </span><span class="s2">&quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-e<span class="w"> </span><span class="nv">REGISTRY_AUTH_HTPASSWD_PATH</span><span class="o">=</span>/auth/htpasswd<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-v<span class="w"> </span>/opt/registry/certs:/certs:z<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-e<span class="w"> </span><span class="nv">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class="o">=</span>/certs/domain.crt<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-e<span class="w"> </span><span class="nv">REGISTRY_HTTP_TLS_KEY</span><span class="o">=</span>/certs/domain.key<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-e<span class="w"> </span><span class="nv">REGISTRY_COMPATIBILITY_SCHEMA1_ENABLED</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-d<span class="w"> </span>docker.io/library/registry:2
</pre></div>
</div>
<p>The details of the options are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--name</span></code> mirror-registry gives the container the name <code class="docutils literal notranslate"><span class="pre">mirror-registry</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-p</span> <span class="pre">$JUMP_HOST_PORT:5000</span></code> for example <code class="docutils literal notranslate"><span class="pre">-p</span> <span class="pre">5000:5000</span></code> exposes port <code class="docutils literal notranslate"><span class="pre">5000</span></code> in the container as port <code class="docutils literal notranslate"><span class="pre">5000</span></code> on the host.</p></li>
<li><p>-v <code class="docutils literal notranslate"><span class="pre">/opt/registry/data:/var/lib/registry:z</span></code> mounts <code class="docutils literal notranslate"><span class="pre">/opt/registry/data</span></code> on the host as <code class="docutils literal notranslate"><span class="pre">/var/lib/registry</span></code> in the container with the correct SELinux context</p></li>
<li><p>-v <code class="docutils literal notranslate"><span class="pre">/opt/registry/auth:/auth:z</span></code> mounts <code class="docutils literal notranslate"><span class="pre">/opt/registry/auth</span></code> on the host as <code class="docutils literal notranslate"><span class="pre">`/auth</span></code> in the container with the correct SELinux context.</p></li>
<li><p>-v <code class="docutils literal notranslate"><span class="pre">/opt/registry/certs:/certs:z</span></code> mounts <code class="docutils literal notranslate"><span class="pre">/opt/registry/certs</span></code> on the hosts as <code class="docutils literal notranslate"><span class="pre">/certs</span></code> in the container with the correct SELinux context.</p></li>
<li><p>-e <code class="docutils literal notranslate"><span class="pre">REGISTRY_AUTH=htpasswd</span></code> uses an <code class="docutils literal notranslate"><span class="pre">bcrypt</span></code> encrypted <code class="docutils literal notranslate"><span class="pre">htpasswd</span></code> file for authentication. File location set by container’s <code class="docutils literal notranslate"><span class="pre">REGISTRY_AUTH_HTPASSWD_PATH</span></code> environment variable.</p></li>
<li><p>-e <code class="docutils literal notranslate"><span class="pre">REGISTRY_AUTH_HTPASSWD_REALM=Registry</span> <span class="pre">Realm</span></code> specifies the realm to use for <code class="docutils literal notranslate"><span class="pre">htpasswd</span></code>.</p></li>
<li><p>-e <code class="docutils literal notranslate"><span class="pre">REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd</span></code> uses the bcrypt-encrypted <code class="docutils literal notranslate"><span class="pre">/auth/htpasswd</span></code> file in the container.</p></li>
<li><p>-e <code class="docutils literal notranslate"><span class="pre">REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt</span></code> sets path to certificate file.</p></li>
<li><p>-e <code class="docutils literal notranslate"><span class="pre">REGISTRY_HTTP_TLS_KEY=/certs/domain.key</span></code> sets path to private key.</p></li>
<li><p>-e <code class="docutils literal notranslate"><span class="pre">REGISTRY_COMPATIBILITY_SCHEMA1_ENABLED=true</span></code> provides backward compatibility for schema1 manifests.</p></li>
<li><p>-d means <code class="docutils literal notranslate"><span class="pre">--detach</span></code> which runs the pod in the background. <code class="docutils literal notranslate"><span class="pre">docker.io/library/registry:latest</span></code> is a registry application that allows for the storage and distribution of images.</p></li>
</ul>
<p><strong>Example</strong>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>podman<span class="w"> </span>run<span class="w"> </span>--name<span class="w"> </span>mirror-registry<span class="w"> </span>-p<span class="w"> </span><span class="m">5000</span>:5000<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-v<span class="w"> </span>/opt/registry/data:/var/lib/registry:z<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-v<span class="w"> </span>/opt/registry/auth:/auth:z<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-e<span class="w"> </span><span class="s2">&quot;REGISTRY_AUTH=htpasswd&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-e<span class="w"> </span><span class="s2">&quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-e<span class="w"> </span><span class="nv">REGISTRY_AUTH_HTPASSWD_PATH</span><span class="o">=</span>/auth/htpasswd<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-v<span class="w"> </span>/opt/registry/certs:/certs:z<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-e<span class="w"> </span><span class="nv">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class="o">=</span>/certs/domain.crt<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-e<span class="w"> </span><span class="nv">REGISTRY_HTTP_TLS_KEY</span><span class="o">=</span>/certs/domain.key<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-e<span class="w"> </span><span class="nv">REGISTRY_COMPATIBILITY_SCHEMA1_ENABLED</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-d<span class="w"> </span>docker.io/library/registry:2
</pre></div>
</div>
</li>
<li><p>Open the required ports for your registry:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>firewall-cmd<span class="w"> </span>--add-port<span class="o">=</span><span class="nv">$JUMP_HOST_PORT</span>/tcp<span class="w"> </span>--zone<span class="o">=</span>internal<span class="w"> </span>--permanent
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>firewall-cmd<span class="w"> </span>--add-port<span class="o">=</span><span class="nv">$JUMP_HOST_PORT</span>/tcp<span class="w"> </span>--zone<span class="o">=</span>public<span class="w"> </span>--permanent
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>firewall-cmd<span class="w"> </span>--reload
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For <code class="docutils literal notranslate"><span class="pre">$JUMP_HOST_PORT</span></code>, specify the port that your mirror registry uses to serve content shown in the examples below as 5000.</p>
</div>
</li>
</ol>
<blockquote>
<div><p><strong>Example</strong>:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>firewall-cmd<span class="w"> </span>--add-port<span class="o">=</span><span class="m">5000</span>/tcp<span class="w"> </span>--zone<span class="o">=</span>internal<span class="w"> </span>--permanent
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>firewall-cmd<span class="w"> </span>--add-port<span class="o">=</span><span class="m">5000</span>/tcp<span class="w"> </span>--zone<span class="o">=</span>public<span class="w"> </span>--permanent
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>firewall-cmd<span class="w"> </span>--reload
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
<ol class="arabic">
<li><p>Add the self-signed certificate to your list of trusted certificates:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cp<span class="w"> </span>/opt/registry/certs/domain.crt<span class="w"> </span>/etc/pki/ca-trust/source/anchors/
</pre></div>
</div>
</li>
<li><p>Trust your certificate to log in to your registry during the mirror process:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>update-ca-trust
</pre></div>
</div>
</li>
<li><p>Verify the certificate.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>verify<span class="w"> </span>/etc/pki/ca-trust/source/anchors/domain.crt
</pre></div>
</div>
</li>
<li><p>Confirm that the registry is available:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>-u<span class="w"> </span>&lt;user_name&gt;:&lt;password&gt;<span class="w"> </span>-k<span class="w"> </span>https://<span class="nv">$JUMP_HOST</span>:JUMP_HOST_PORT/v2/_catalog
</pre></div>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">&lt;user_name&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;password&gt;</span></code>, specify the user name and password for your registry. The <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">JUMP_HOST=&lt;Your_jump_hostname&gt;</span></code> ensures the correct <code class="docutils literal notranslate"><span class="pre">$JUMP_HOST</span></code> is set. For <code class="docutils literal notranslate"><span class="pre">JUMP_HOST_PORT</span></code>, specify the port that your mirror registry uses to serve content.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the command output displays an empty repository, your registry is available.</p>
</div>
</li>
</ol>
</section>
<section id="authenticate-the-mirror-registry">
<h2>Authenticate the mirror registry<a class="headerlink" href="#authenticate-the-mirror-registry" title="Permalink to this heading"></a></h2>
<p>For authenticating your mirror registry, you need to configure additional trust stores for image registry access in your Openshift Container Platform cluster. You can create a <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code> in the <code class="docutils literal notranslate"><span class="pre">openshift-config</span></code> namespace and use its name in <code class="docutils literal notranslate"><span class="pre">AdditionalTrustedCA</span></code> in the <code class="docutils literal notranslate"><span class="pre">image.config.openshift.io</span></code> resource. This provides additional CAs that should be trusted when contacting external registries.</p>
<ol class="arabic">
<li><p>Set the following environment variable:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">JUMP_HOST</span><span class="o">=</span>&lt;Your_jump_hostname&gt;
</pre></div>
</div>
</li>
<li><p>Create a ConfigMap in the <code class="docutils literal notranslate"><span class="pre">openshift-config</span></code> namespace:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>create<span class="w"> </span>configmap<span class="w"> </span>registry-config<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--from-file<span class="o">=</span><span class="si">${</span><span class="nv">JUMP_HOST</span><span class="si">}</span>..5000<span class="o">=</span>/etc/pki/ca-trust/source/anchors/domain.crt<span class="w">  </span><span class="se">\</span>
<span class="w">   </span>-n<span class="w"> </span>openshift-config
</pre></div>
</div>
</li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">AdditionalTrustedCA</span></code> in the <code class="docutils literal notranslate"><span class="pre">image.config.openshift.io</span></code> resource:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>patch<span class="w"> </span>image.config.openshift.io/cluster<span class="w"> </span><span class="se">\</span>
--patch<span class="w"> </span><span class="s1">&#39;{&quot;spec&quot;:{&quot;additionalTrustedCA&quot;:{&quot;name&quot;:&quot;registry-config&quot;}}}&#39;</span><span class="w"> </span>--type<span class="o">=</span>merge<span class="w"> </span><span class="se">\</span>
--type<span class="o">=</span>merge
</pre></div>
</div>
</li>
</ol>
</section>
<section id="configuring-credentials-that-allow-images-to-be-mirrored">
<h2>Configuring credentials that allow images to be mirrored<a class="headerlink" href="#configuring-credentials-that-allow-images-to-be-mirrored" title="Permalink to this heading"></a></h2>
<p>Create a container image registry credentials file that allows mirroring images from Red Hat to your mirror registry.</p>
<blockquote>
<div><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not use this image registry credentials file as the pull secret when you install a cluster. If you provide this file when you install cluster, all of the machines in the cluster will have write access to your mirror registry.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This process requires that you have write access to a container image registry on the mirror registry and adds the credentials to a registry pull secret.</p>
</div>
</div></blockquote>
<ol class="arabic">
<li><p>Download your pull secret from the <a class="reference external" href="https://console.redhat.com/openshift/install/pull-secret">Pull Secret</a> page on the Red Hat OpenShift Cluster Manager site.</p></li>
<li><p>Generate the base64-encoded user name and password or token for your mirror registry:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;&lt;user_name&gt;:&lt;password&gt;&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-w0
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">BGVtbYk3ZHAtqXs=</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For the <code class="docutils literal notranslate"><span class="pre">&lt;user_name&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;password&gt;</span></code>, specify the user name and password that you configured for your registry.</p>
</div>
</li>
<li><p>Make a copy of your pull secret in JSON format:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>&lt;path_to_pull_secret&gt;/pull-secret.text<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>.<span class="w">  </span>&gt;<span class="w"> </span>&lt;path&gt;/&lt;pull-secret-file&gt;
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Specify the path to the folder to store the pull secret in and a name for the JSON file that you create.</p>
</div>
<p>The contents of the file resemble the following example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">{</span>
<span class="go">   &quot;auths&quot;: {</span>
<span class="go">     &quot;cloud.openshift.com&quot;: {</span>
<span class="go">       &quot;auth&quot;: &quot;b3BlbnNo...&quot;,</span>
<span class="go">       &quot;email&quot;: &quot;you@example.com&quot;</span>
<span class="go">    },</span>
<span class="go">    &quot;quay.io&quot;: {</span>
<span class="go">      &quot;auth&quot;: &quot;b3BlbnNo...&quot;,</span>
<span class="go">      &quot;email&quot;: &quot;you@example.com&quot;</span>
<span class="go">    },</span>
<span class="go">    &quot;registry.connect.redhat.com&quot;: {</span>
<span class="go">      &quot;auth&quot;: &quot;NTE3Njg5Nj...&quot;,</span>
<span class="go">      &quot;email&quot;: &quot;you@example.com&quot;</span>
<span class="go">    },</span>
<span class="go">    &quot;registry.redhat.io&quot;: {</span>
<span class="go">      &quot;auth&quot;: &quot;NTE3Njg5Nj...&quot;,</span>
<span class="go">      &quot;email&quot;: &quot;you@example.com&quot;</span>
<span class="go">    }</span>
<span class="go">   }</span>
<span class="go">}</span>
</pre></div>
</div>
</li>
<li><p>Edit the new file and add a section that describes your registry to it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&quot;auths&quot;: {</span>
<span class="go">  &quot;&lt;mirror_registry&gt;:5000&quot;: {</span>
<span class="go">    &quot;auth&quot;: &quot;&lt;credentials&gt;&quot;,</span>
<span class="go">    &quot;email&quot;: &quot;you@example.com&quot;</span>
<span class="go">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For &lt;mirror_registry&gt;, specify the registry domain name, and optionally the port, that your mirror registry uses to serve content. Following the logic of this example with the registry being setup on the hump host this is <code class="docutils literal notranslate"><span class="pre">jump_hostname</span></code> or <code class="docutils literal notranslate"><span class="pre">jump_hostname:5000</span></code>. For &lt;credentials&gt;, specify the base64-encoded user name and password for the mirror registry.</p>
</div>
<p>The file resembles the following example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">{</span>
<span class="go">  &quot;auths&quot;: {</span>
<span class="go">    &quot;jump_hostname:5000&quot;: {</span>
<span class="go">      &quot;auth&quot;: &quot;BGVtbYk3ZHAtqXs=&quot;,</span>
<span class="go">      &quot;email&quot;: &quot;you@example.com&quot;</span>
<span class="go">    },</span>
<span class="go">    &quot;cloud.openshift.com&quot;: {</span>
<span class="go">      &quot;auth&quot;: &quot;b3BlbnNo...&quot;,</span>
<span class="go">      &quot;email&quot;: &quot;you@example.com&quot;</span>
<span class="go">    },</span>
<span class="go">    &quot;quay.io&quot;: {</span>
<span class="go">      &quot;auth&quot;: &quot;b3BlbnNo...&quot;,</span>
<span class="go">      &quot;email&quot;: &quot;you@example.com&quot;</span>
<span class="go">    },</span>
<span class="go">    &quot;registry.connect.redhat.com&quot;: {</span>
<span class="go">      &quot;auth&quot;: &quot;NTE3Njg5Nj...&quot;,</span>
<span class="go">      &quot;email&quot;: &quot;you@example.com&quot;</span>
<span class="go">    },</span>
<span class="go">    &quot;registry.redhat.io&quot;: {</span>
<span class="go">      &quot;auth&quot;: &quot;NTE3Njg5Nj...&quot;,</span>
<span class="go">      &quot;email&quot;: &quot;you@example.com&quot;</span>
<span class="go">    }</span>
<span class="go">  }</span>
<span class="go">}</span>
</pre></div>
</div>
</li>
</ol>
<p>Update the global pull secret for your cluster by either replacing the current pull secret or appending a new pull secret. For more information and generic instructions see, <a class="reference external" href="https://docs.openshift.com/container-platform/latest/openshift_images/managing_images/using-image-pull-secrets.html#images-update-global-pull-secret_using-image-pull-secrets">here</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Cluster resources must adjust to the new pull secret, which can temporarily limit the usability of the cluster.</p>
</div>
<p>Append a new pull secret to the existing pull secret by completing the following steps:</p>
<ol class="arabic">
<li><p>Enter the following command to download the pull secret:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>get<span class="w"> </span>secret/pull-secret<span class="w"> </span>-n<span class="w"> </span>openshift-config<span class="w"> </span>--template<span class="o">=</span><span class="s1">&#39;{{index .data &quot;.dockerconfigjson&quot; | base64decode}}&#39;</span><span class="w"> </span>&gt;/tmp/pull-secret.json
</pre></div>
</div>
</li>
<li><p>Enter the following command to add the new pull secret:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>registry<span class="w"> </span>login<span class="w"> </span>--registry<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">JUMP_HOST</span><span class="si">}</span><span class="s2">:5000&quot;</span><span class="w"> </span>--auth-basic<span class="o">=</span><span class="s2">&quot;&lt;username&gt;:&lt;password&gt;&quot;</span><span class="w"> </span>--to<span class="o">=</span>/tmp/pull-secret.json
</pre></div>
</div>
</li>
<li><p>Enter the following command to update the global pull secret for your cluster:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span><span class="nb">set</span><span class="w"> </span>data<span class="w"> </span>secret/pull-secret<span class="w"> </span>-n<span class="w"> </span>openshift-config<span class="w"> </span>--from-file<span class="o">=</span>.dockerconfigjson<span class="o">=</span>/tmp/pull-secret.json
</pre></div>
</div>
</li>
</ol>
</section>
<section id="mirror-the-operator-catalogs-on-a-disconnected-cluster">
<h2>Mirror the Operator catalogs on a disconnected cluster<a class="headerlink" href="#mirror-the-operator-catalogs-on-a-disconnected-cluster" title="Permalink to this heading"></a></h2>
<p>You can mirror all operators of a certain index image into your disconnected cluster, but the image may be huge, so you can prune an index image to keep only a few of the operators you want to use.</p>
<p>This guide demonstrates how to mirror specific Operators namely the <strong>Node Feature Discovery</strong> and the <strong>NVIDIA GPU Operator</strong>. For more general information, see <a class="reference external" href="https://docs.openshift.com/container-platform/latest/operators/admin/olm-restricted-networks.html">Using Operator Lifecycle Manager on restricted networks</a>.</p>
</section>
<section id="disabling-the-default-operatorhub-sources">
<h2>Disabling the default OperatorHub sources<a class="headerlink" href="#disabling-the-default-operatorhub-sources" title="Permalink to this heading"></a></h2>
<p>Operator catalogs that source content provided by Red Hat and community projects are configured for OperatorHub by default during an OpenShift Container Platform installation. In a restricted network environment, you must disable the default catalogs as a cluster administrator. You can then configure OperatorHub to use local catalog sources.</p>
<ol class="arabic">
<li><p>Disable the sources for the default catalogs by adding <code class="docutils literal notranslate"><span class="pre">disableAllDefaultSources:</span> <span class="pre">true</span></code> to the OperatorHub object:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>patch<span class="w"> </span>OperatorHub<span class="w"> </span>cluster<span class="w"> </span>--type<span class="w"> </span>json<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="s1">&#39;[{&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/spec/disableAllDefaultSources&quot;, &quot;value&quot;: true}]&#39;</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="pruning-an-index-image">
<h2>Pruning an index image<a class="headerlink" href="#pruning-an-index-image" title="Permalink to this heading"></a></h2>
<p>An index image, based on the Operator bundle format, is a containerized snapshot of an Operator catalog. You can prune an index of all but a specified list of packages, which creates a copy of the source index containing only the Operators that you want.</p>
<p>When configuring Operator Lifecycle Manager (OLM) to use mirrored content on restricted network OpenShift Container Platform clusters, use this pruning method to only mirror the subset of Operators from the default catalogs required to successfully install the <strong>NVIDIA GPU Operator</strong>.</p>
<section id="determine-the-operators-of-interest">
<h3>Determine the Operators of interest<a class="headerlink" href="#determine-the-operators-of-interest" title="Permalink to this heading"></a></h3>
<p>The four primary official indexes the OpenShift Container Platform uses are:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">registry.redhat.io/redhat/certified-operator-index:v4.9</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">registry.redhat.io/redhat/redhat-operator-index:v4.9</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">registry.redhat.io/redhat/community-operator-index:v4.9</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">registry.redhat.io/redhat/redhat-marketplace-index:v4.9</span></code></p></li>
</ul>
<p>The table below provides the relevant information extracted from the steps below for the Operators of interest to this procedure.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 30%" />
<col style="width: 51%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>CatalogSource Name</p></th>
<th class="head"><p>Operator Name</p></th>
<th class="head"><p>Index Image Name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>certified-operators</p></td>
<td><p>gpu-operator-certified</p></td>
<td><p>registry.redhat.io/redhat/certified-operator-index:v4.9</p></td>
</tr>
<tr class="row-odd"><td><p>redhat-operators</p></td>
<td><p>nfd</p></td>
<td><p>registry.redhat.io/redhat/redhat-operator-index:v4.9</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>How these are determined is illustrated below in steps 2,3 and 4.</p>
<ol class="arabic">
<li><p>Authenticate with <code class="docutils literal notranslate"><span class="pre">registry.redhat.io</span></code> and your target registry as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">REGISTRY_AUTH_FILE</span><span class="o">=</span>&lt;path_to_pull_secret&gt;/pull-secret.json
</pre></div>
</div>
</li>
<li><p>Run the source index image that you want to prune in a container. For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>podman<span class="w"> </span>run<span class="w"> </span>-p50051:50051<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-it<span class="w"> </span>registry.redhat.io/redhat/redhat-operator-index:v4.9
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Trying to pull registry.redhat.io/redhat/redhat-operator-index:v4.9...</span>
<span class="go">Getting image source signatures</span>
<span class="go">Copying blob ae8a0c23f5b1 done</span>
<span class="go">...</span>
<span class="go">INFO[0000] serving registry                              database=/database/index.db port=50051</span>
</pre></div>
</div>
</li>
<li><p>In a separate terminal session, use the <code class="docutils literal notranslate"><span class="pre">grpcurl</span></code> command to get a list of the packages provided by the index:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>grpcurl<span class="w"> </span>-plaintext<span class="w"> </span>localhost:50051<span class="w"> </span>api.Registry/ListPackages<span class="w"> </span>&gt;<span class="w"> </span>packages.out
</pre></div>
</div>
</li>
<li><p>Inspect the <code class="docutils literal notranslate"><span class="pre">packages.out</span></code> file and identify which package names from this list you want to keep in your pruned index. For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">{</span>
<span class="go">  &quot;name&quot;: &quot;advanced-cluster-management&quot;</span>
<span class="go">}</span>
<span class="go">...</span>
<span class="go">{</span>
<span class="go">  &quot;name&quot;: &quot;jaeger-product&quot;</span>
<span class="go">}</span>
<span class="go">...</span>
<span class="go">{</span>
<span class="go">{</span>
<span class="go">  &quot;name&quot;: &quot;quay-operator&quot;</span>
<span class="go">}</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="pruning-index-images">
<h3>Pruning index images<a class="headerlink" href="#pruning-index-images" title="Permalink to this heading"></a></h3>
<p>Use this pruning method to mirror only the subset of Operators required.</p>
<ol class="arabic">
<li><p>Authenticate with <code class="docutils literal notranslate"><span class="pre">registry.redhat.io</span></code> and your target registry as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">REGISTRY_AUTH_FILE</span><span class="o">=</span>&lt;path_to_pull_secret&gt;/pull-secret.json
</pre></div>
</div>
</li>
<li><p>Set the following environment variable:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">JUMP_HOST</span><span class="o">=</span>&lt;Your_jump_hostname&gt;
</pre></div>
</div>
</li>
<li><p>For the <strong>NVIDIA GPU Operator</strong> run the following command to prune the source index of all but the specified packages:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>opm<span class="w"> </span>index<span class="w"> </span>prune<span class="w"> </span>-f<span class="w"> </span>registry.redhat.io/redhat/certified-operator-index:v4.9<span class="w"> </span>-p<span class="w"> </span>gpu-operator-certified<span class="w"> </span>-t<span class="w"> </span><span class="si">${</span><span class="nv">JUMP_HOST</span><span class="si">}</span>:5000/catalog/certified-operator-index:v4.9
</pre></div>
</div>
</li>
<li><p>For the <strong>Node Feature Discovery Operator</strong> run the following command to prune the source index of all but the specified packages:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>opm<span class="w"> </span>index<span class="w"> </span>prune<span class="w"> </span>-f<span class="w"> </span>registry.redhat.io/redhat/redhat-operator-index:v4.9<span class="w"> </span>-p<span class="w"> </span>nfd<span class="w"> </span>-t<span class="w"> </span><span class="si">${</span><span class="nv">JUMP_HOST</span><span class="si">}</span>:5000/catalog/redhat-operator-index:v4.9
</pre></div>
</div>
</li>
<li><p>Run the following command to push the <strong>NVIDIA GPU Operator</strong> index image to your target registry:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>podman<span class="w"> </span>push<span class="w"> </span><span class="si">${</span><span class="nv">JUMP_HOST</span><span class="si">}</span>:5000/catalog/certified-operator-index:v4.9
</pre></div>
</div>
</li>
<li><p>Run the following command to push the <strong>Node Feature Discovery Operator</strong> index images to your target registry:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>podman<span class="w"> </span>push<span class="w"> </span><span class="si">${</span><span class="nv">JUMP_HOST</span><span class="si">}</span>:5000/catalog/redhat-operator-index:v4.9
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="mirror-node-feature-discovery-and-the-nvidia-gpu-operator-catalog">
<h2>Mirror Node Feature Discovery and the NVIDIA GPU Operator Catalog<a class="headerlink" href="#mirror-node-feature-discovery-and-the-nvidia-gpu-operator-catalog" title="Permalink to this heading"></a></h2>
<p>You can mirror the Operator content of a Red Hat-provided catalog, or a custom catalog, into a container image registry using the <code class="docutils literal notranslate"><span class="pre">oc</span> <span class="pre">adm</span> <span class="pre">catalog</span> <span class="pre">mirror</span></code> command. The target registry must support <a class="reference external" href="https://docs.docker.com/registry/spec/manifest-v2-2/">Docker v2-2</a>. For a cluster on a restricted network, this registry can be one that the cluster has network access to, such as a mirror registry created during a restricted network cluster installation.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">oc</span> <span class="pre">adm</span> <span class="pre">catalog</span> <span class="pre">mirror</span></code> command also automatically mirrors the index image specified during the mirroring process, whether it be a Red Hat-provided index image or your own custom-built index image, to the target registry. You can then use the mirrored index image to create a catalog source that allows Operator Lifecycle Manager (OLM) to load the mirrored catalog onto your OpenShift Container Platform cluster.</p>
<ol class="arabic">
<li><p>Set the following environment variable:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">REGISTRY_AUTH_FILE</span><span class="o">=</span>&lt;path_to_pull_secret&gt;/pull-secret.json
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">JUMP_HOST</span><span class="o">=</span>&lt;Your_jump_hostname&gt;
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Specify the fully qualified domain name (FQDN) for <strong>&lt;Your_jump_hostname&gt;</strong>.</p>
</div>
</li>
<li><p>Run the following command to mirror the GPU content:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The assumption here is your mirror registry is on the same network.</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>adm<span class="w"> </span>catalog<span class="w"> </span>mirror<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--insecure<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--index-filter-by-os<span class="o">=</span><span class="s1">&#39;linux/amd64&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REGISTRY_AUTH_FILE</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="gp">   $</span><span class="o">{</span>JUMP_HOST<span class="o">}</span>:5000/catalog/certified-operator-index:v4.9<span class="w"> </span><span class="si">${</span><span class="nv">JUMP_HOST</span><span class="si">}</span>:5000/operators
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The namespace on your mirror registry used to store the mirrored Operator content is called <cite>operators</cite> above.</p>
</div>
</li>
<li><p>Run the following command to mirror the <strong>Node Feature Discovery Operator</strong>:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The assumption here is your mirror registry is on the same network.</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>adm<span class="w"> </span>catalog<span class="w"> </span>mirror<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--insecure<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--index-filter-by-os<span class="o">=</span><span class="s1">&#39;linux/amd64&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REGISTRY_AUTH_FILE</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="gp">   $</span><span class="o">{</span>JUMP_HOST<span class="o">}</span>:5000/catalog/redhat-operator-index:v4.9<span class="w"> </span><span class="si">${</span><span class="nv">JUMP_HOST</span><span class="si">}</span>:5000/operators
</pre></div>
</div>
</li>
<li><p>After mirroring the content to your registry, inspect the manifests directory that is generated in your current directory.</p>
<p>The manifest directory format is:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">manifests-&lt;index_image_name&gt;-&lt;random_number&gt;</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div><p><strong>Example</strong>:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">manifests-certified-operator-index-1634633799</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">manifests-redhat-operator-index-1634633663</span>
</pre></div>
</div>
</div></blockquote>
<p>Repeat the steps below for the different index images.</p>
</div></blockquote>
<ol class="arabic">
<li><p>On a host with access to the disconnected cluster, create the ImageContentSourcePolicy (ICSP) object by running the following command to specify the <code class="docutils literal notranslate"><span class="pre">imageContentSourcePolicy.yaml</span></code> file in your manifests directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>&lt;path/to/manifests/dir&gt;/imageContentSourcePolicy.yaml
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;path/to/manifests/dir&gt;</span></code> is the path to the manifests directory for your mirrored content.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Applying the ICSP causes all worker nodes in the cluster to restart. You must wait for this reboot process to finish cycling through each of your worker nodes before proceeding.</p>
</div>
</li>
<li><p>Customize the <code class="docutils literal notranslate"><span class="pre">mapping.txt</span></code> file with the <code class="docutils literal notranslate"><span class="pre">REGISTRY_AUTH_FILE</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>image<span class="w"> </span>mirror<span class="w"> </span>-f<span class="w"> </span>&lt;path/to/manifests/dir&gt;/mapping.txt<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">REGISTRY_AUTH_FILE</span><span class="si">}</span><span class="w"> </span>--insecure
</pre></div>
</div>
</li>
</ol>
</section>
<section id="creating-a-catalog-from-an-index-image">
<h2>Creating a catalog from an index image<a class="headerlink" href="#creating-a-catalog-from-an-index-image" title="Permalink to this heading"></a></h2>
<p>You can create an Operator catalog from an index image and apply it to an OpenShift Container Platform cluster for use with Operator Lifecycle Manager (OLM).</p>
<p>Create a CatalogSource object that references your <strong>Node Feature Discovery Operator</strong> index images. Previously you used the <code class="docutils literal notranslate"><span class="pre">oc</span> <span class="pre">adm</span> <span class="pre">catalog</span> <span class="pre">mirror</span></code> command to mirror your catalog to a target registry, so you can use the generated <code class="docutils literal notranslate"><span class="pre">catalogSource.yaml</span></code> file in <code class="docutils literal notranslate"><span class="pre">manifests-redhat-operator-index-&lt;random_number&gt;</span></code> as a starting point.</p>
<ol class="arabic">
<li><p>Modify the following to your specifications and save it as a <code class="docutils literal notranslate"><span class="pre">catalogSource_redhat_operator.yaml</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">operators.coreos.com/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CatalogSource</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redhat-operator-index</span>
<span class="w">   </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openshift-marketplace</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${JUMP_HOST}:5000/operators/catalog-redhat-operator-index:v4.9</span>
<span class="w">  </span><span class="nt">sourceType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grpc</span>
<span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">My Operator Catalog</span>
<span class="w">  </span><span class="nt">publisher</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;publisher_name&gt;</span>
<span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">registryPoll</span><span class="p">:</span>
<span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30m</span>
</pre></div>
</div>
</li>
<li><p>Use the file to create the <code class="docutils literal notranslate"><span class="pre">CatalogSource</span></code> object:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>catalogSource_redhat_operator.yaml
</pre></div>
</div>
</li>
</ol>
<p>Create a CatalogSource object that references your <strong>NVIDIA GPU Operator</strong> index image. Previously you used the <code class="docutils literal notranslate"><span class="pre">oc</span> <span class="pre">adm</span> <span class="pre">catalog</span> <span class="pre">mirror</span></code> command to mirror your catalog to a target registry, so you can use the generated <code class="docutils literal notranslate"><span class="pre">catalogSource.yaml</span></code> file in <code class="docutils literal notranslate"><span class="pre">manifests-certified-operator-index-&lt;random_number&gt;</span></code> as a starting point.</p>
<ol class="arabic">
<li><p>Modify the following to your specifications and save it as a <code class="docutils literal notranslate"><span class="pre">catalogSource_certified_operator.yaml</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">operators.coreos.com/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CatalogSource</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">certified-operator-index</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openshift-marketplace</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${JUMP_HOST}:5000/operators/catalog-certified-operator-index:v4.9</span>
<span class="w">  </span><span class="nt">sourceType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grpc</span>
<span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">My Operator Catalog</span>
<span class="w">  </span><span class="nt">publisher</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;publisher_name&gt;</span>
<span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">registryPoll</span><span class="p">:</span>
<span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30m</span>
</pre></div>
</div>
</li>
<li><p>Use the file to create the <code class="docutils literal notranslate"><span class="pre">CatalogSource</span></code> object:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>catalogSource_certified_operator.yaml
</pre></div>
</div>
</li>
</ol>
</section>
<section id="verify-the-mirrored-catalog-source">
<h2>Verify the mirrored catalog source<a class="headerlink" href="#verify-the-mirrored-catalog-source" title="Permalink to this heading"></a></h2>
<p>Verify the following resources are successfully created.</p>
<ol class="arabic">
<li><p>Check the pods:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>openshift-marketplace
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">NAME                                   READY   STATUS             RESTARTS      AGE</span>
<span class="go">certified-operator-index-bq7bt         0/1     Running            0             17h</span>
<span class="go">marketplace-operator-d65d479cc-7zblj   1/1     Running            1 (23d ago)   23d</span>
<span class="go">redhat-operator-index-725tv            0/1     Running            0             17h</span>
</pre></div>
</div>
</li>
<li><p>Check the package manifest:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>get<span class="w"> </span>packagemanifest<span class="w"> </span>-n<span class="w"> </span>openshift-marketplace
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">NAME                       DISPLAY                       TYPE   PUBLISHER        AGE</span>
<span class="go">certified-operator-index   Openshift Telco Docs          grpc   Openshift Docs   20h</span>
<span class="go">redhat-operator-index      Openshift Telco Docs          grpc   Openshift Docs   20h</span>
</pre></div>
</div>
</li>
<li><p>Check the catalogsource:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>get<span class="w"> </span>catalogsource<span class="w"> </span>-n<span class="w"> </span>openshift-marketplace
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>openshift-marketplace
</pre></div>
</div>
</li>
<li><p>Log in to the OpenShift Container Platform web console and click <strong>Operators</strong> → <strong>OperatorHub</strong>.</p>
<p>You can find the mirrored operator after you login to the OpenShift Container Platform console. You can get started deploying operators in your disconnected cluster now!</p>
</li>
</ol>
</section>
<section id="install-the-node-feature-discovery-operator">
<h2>Install the Node Feature Discovery Operator<a class="headerlink" href="#install-the-node-feature-discovery-operator" title="Permalink to this heading"></a></h2>
<p>Follow the guidance <a class="reference internal" href="install-nfd.html#install-nfd-1-9-0"><span class="std std-ref">here</span></a> to install the <strong>Node Feature Discovery (NFD) Operator</strong>. If you are installing on any Openshift Container Platform version other than <code class="docutils literal notranslate"><span class="pre">4.8.19</span></code>, <code class="docutils literal notranslate"><span class="pre">4.8.21</span></code> or <code class="docutils literal notranslate"><span class="pre">4.9.8</span></code> proceed to <a class="reference internal" href="#install-gpu-noworkaround-1-9-0"><span class="std std-ref">Install the NVIDIA GPU Operator</span></a>.</p>
<section id="optional-configure-repoconfig-using-local-yum-repository">
<h3>Optional: Configure repoConfig using Local Yum Repository<a class="headerlink" href="#optional-configure-repoconfig-using-local-yum-repository" title="Permalink to this heading"></a></h3>
<p>These steps only need to be carried out if installing the <strong>NVIDIA GPU Operator</strong> on OpenShift Container Platform version <code class="docutils literal notranslate"><span class="pre">4.8.19</span></code>, <code class="docutils literal notranslate"><span class="pre">4.8.21</span></code> or <code class="docutils literal notranslate"><span class="pre">4.9.8</span></code>.</p>
<p>Carry on the following steps on the jump host when it is connected to the cluster.</p>
<ol class="arabic">
<li><p>Create a Local-Base.repo as below:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">JUMP_HOST</span><span class="o">=</span>&lt;Your_jump_hostname&gt;
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>&lt;&lt;EOF<span class="w"> </span>&gt;Local-Base.repo
<span class="go">[rhel-8-for-x86_64-baseos-rpms]</span>
<span class="go">name=Red Hat Enterprise Linux 8 for  - BaseOS from RHUI (RPMs)</span>
<span class="go">baseurl= http://${JUMP_HOST}:8080/content/dist/rhel8/8/x86_64/baseos/os</span>
<span class="go">gpgcheck=1</span>
<span class="go">gpgkey=file:/etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6</span>
<span class="go">protect=1</span>
<span class="go">priority=1</span>
<span class="go">enabled=1</span>

<span class="go">[rhel-8-for-x86_64-appstream-rpms]</span>
<span class="go">name=Red Hat Enterprise Linux 8 for  - AppStream from RHUI (RPMs)</span>
<span class="go">baseurl= http://${JUMP_HOST}:8080/content/dist/rhel8/8/x86_64/appstream/os</span>
<span class="go">enabled=1</span>
<span class="go">gpgcheck=0</span>
<span class="go">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release</span>
<span class="go">protect=1</span>
<span class="go">priority=1</span>
<span class="go">EOF</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="optional-installing-the-nvidia-gpu-operator-on-openshift-version-4-8-19-4-8-21-4-9-8">
<h2>Optional: Installing the NVIDIA GPU Operator on OpenShift version <code class="docutils literal notranslate"><span class="pre">4.8.19</span></code>, <code class="docutils literal notranslate"><span class="pre">4.8.21</span></code>, <code class="docutils literal notranslate"><span class="pre">4.9.8</span></code><a class="headerlink" href="#optional-installing-the-nvidia-gpu-operator-on-openshift-version-4-8-19-4-8-21-4-9-8" title="Permalink to this heading"></a></h2>
<p>These steps only need to be carried out if installing the <strong>NVIDIA GPU Operator</strong> on OpenShift Container Platform version <code class="docutils literal notranslate"><span class="pre">4.8.19</span></code>, <code class="docutils literal notranslate"><span class="pre">4.8.21</span></code> or <code class="docutils literal notranslate"><span class="pre">4.9.8</span></code>.</p>
<p>With the <strong>Node Feature Discovery Operator</strong> installed you can continue with the final step and install the <strong>NVIDIA GPU Operator</strong>.</p>
<ol class="arabic">
<li><p>In the OpenShift Container Platform web console from the side menu, select <strong>Operators</strong> &gt; <strong>OperatorHub</strong>, then search for the <strong>NVIDIA GPU Operator</strong>. For additional information see the <a class="reference external" href="https://docs.openshift.com/container-platform/latest/operators/admin/olm-adding-operators-to-cluster.html">Red Hat OpenShift Container Platform documentation</a>.</p></li>
<li><p>Select the <strong>NVIDIA GPU Operator</strong>, click <strong>Install</strong>. In the subsequent screen click <strong>Install</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here, you can select the namespace where you want to deploy the GPU Operator. The suggested namespace to use is the <code class="docutils literal notranslate"><span class="pre">nvidia-gpu-operator</span></code>. You can choose any existing namespace or create a new namespace under <strong>Select a Namespace</strong>.</p>
<p>If you install in any other namespace other than <code class="docutils literal notranslate"><span class="pre">nvidia-gpu-operator</span></code>, the GPU Operator will <strong>not</strong> automatically enable namespace monitoring, and metrics and alerts will <strong>not</strong> be collected by Prometheus.
If only trusted operators are installed in this namespace, you can manually enable namespace monitoring with this command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>oc<span class="w"> </span>label<span class="w"> </span>ns/<span class="nv">$NAMESPACE_NAME</span><span class="w"> </span>openshift.io/cluster-monitoring<span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
</div>
</li>
<li><p>Back in the <strong>Installed Operators</strong> menu option select the <strong>NVIDIA GPU Operator</strong> and the <strong>ClusterPolicy</strong> tab, then click <strong>Create ClusterPolicy</strong>. The platform assigns the default name <em>gpu-cluster-policy</em>.</p></li>
<li><p>Edit the <code class="docutils literal notranslate"><span class="pre">Config</span> <span class="pre">Map</span> <span class="pre">Name</span></code> field entering the value <code class="docutils literal notranslate"><span class="pre">yum-repos-d</span></code>.</p></li>
<li><p>Edit the <code class="docutils literal notranslate"><span class="pre">Destination</span> <span class="pre">Dir</span></code> field entering the value <code class="docutils literal notranslate"><span class="pre">/etc/yum.repos.d</span></code>.</p></li>
<li><p>Click <strong>Create</strong>.</p>
<p>At this point, the GPU Operator proceeds and installs all the required components to set up the NVIDIA GPUs in the OpenShift 4 cluster. This may take a while so be patient and wait at least 10-20 minutes before digging deeper into any form of troubleshooting.</p>
</li>
<li><p>The status of the newly deployed ClusterPolicy <em>gpu-cluster-policy</em> for the <strong>NVIDIA GPU Operator</strong> changes to <code class="docutils literal notranslate"><span class="pre">State:ready</span></code> once the installation succeeded.</p>
<img alt="../../../../_images/cluster_policy_suceed4.png" src="../../../../_images/cluster_policy_suceed4.png" />
</li>
</ol>
<p>You can now proceed to <a class="reference internal" href="install-gpu-ocp.html#install-nvidiagpu-1-9-0"><span class="std std-ref">install and verify the NVIDIA GPU Operator</span></a>.</p>
</section>
<section id="install-the-nvidia-gpu-operator">
<span id="install-gpu-noworkaround-1-9-0"></span><h2>Install the NVIDIA GPU Operator<a class="headerlink" href="#install-the-nvidia-gpu-operator" title="Permalink to this heading"></a></h2>
<p>You can now proceed to <a class="reference internal" href="install-gpu-ocp.html#install-nvidiagpu-1-9-0"><span class="std std-ref">install and verify the NVIDIA GPU Operator</span></a>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="clean-up.html" class="btn btn-neutral float-left" title="Cleanup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="troubleshooting-gpu-ocp.html" class="btn btn-neutral float-right" title="Troubleshooting" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2023, NVIDIA Corporation.
      <span class="lastupdated">Last updated on 2023-02-22.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
  a:link, a:visited {
    color: #76b900;
  }

  a:hover {
    color: #8c0;
  }

  .rst-content dl:not(.docutils) dt {
    background: rgba(118, 185, 0, 0.1);
    color: rgba(59,93,0,1);
    border-top: solid 3px rgba(59,93,0,1);
  }
  </style>
  

</body>
</html>