<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Appendix &mdash; NVIDIA Cloud Native Technologies  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/nvidia.ico"/>
    <link rel="canonical" href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/archive/22.9.1/appendix.html"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script src="../../../_static/js/google-analytics/google-analytics-tracker.js"></script>
        <script src="../../../_static/js/google-analytics/google-analytics-write.js"></script>
        <script src="//assets.adobedtm.com/b92787824f2e0e9b68dc2e993f9bd995339fe417/satelliteLib-7ba51e58dc61bcb0e9311aadd02a0108ab24cc6c.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Overview" href="../22.9.0/overview.html" />
    <link rel="prev" title="GPU Operator with KubeVirt" href="gpu-operator-kubevirt.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" > 
            <a href="../../../contents.html">
            <img src="../../../_static/NVLogo_H_B&W.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #76b900;
    }

    .wy-side-nav-search a:link, .wy-nav-top a:link {
      color: #fff;
    }
    .wy-side-nav-search a:visited, .wy-nav-top a:visited {
      color: #fff;
    }
    .wy-side-nav-search a:hover, .wy-nav-top a:hover {
      color: #fff;
    }

    .wy-menu-vertical a:link, .wy-menu-vertical a:visited {
      color: #d9d9d9
    }

    .wy-menu-vertical a:active {
      background-color: #76b900
    }

    .wy-side-nav-search>div.version {
      color: rgba(0, 0, 0, 0.3)
    }

    .wy-nav-content {
      max-width: 1000px;
    }
  </style>
  
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">NVIDIA Container Toolkit</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../container-toolkit/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../container-toolkit/concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../container-toolkit/arch-overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../container-toolkit/install-guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../container-toolkit/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../container-toolkit/user-guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../container-toolkit/release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../container-toolkit/archive.html">Archive</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">NVIDIA GPU Operator</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About the Operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../platform-support.html">Platform Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html#install-nvidia-gpu-operator">Install NVIDIA GPU Operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu-driver-upgrades.html">GPU Driver Upgrades</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced-configurations.html">Advanced Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openshift/contents.html">GPU Operator on OpenShift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">Licenses and Contributing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../archive.html">Archive</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../archive.html#id1">22.9.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../archive.html#id2">22.9.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../archive.html#id3">1.11.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../archive.html#id4">1.11.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../archive.html#id5">1.10.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../archive.html#id6">1.9.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../archive.html#id7">1.9.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../archive.html#id8">1.8</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Kubernetes with GPUs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../kubernetes/install-k8s.html">Install Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kubernetes/mig-k8s.html">MIG Support in Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kubernetes/anthos-guide.html">NVIDIA GPUs with Google Cloud’s Anthos</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GPU Telemetry</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu-telemetry/dcgm-exporter.html">DCGM-Exporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu-telemetry/dcgm-exporter.html#integrating-gpu-telemetry-into-kubernetes">Integrating GPU Telemetry into Kubernetes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Multi-Instance GPU</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mig/mig.html">Multi-Instance GPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mig/mig-k8s.html">MIG Support in Kubernetes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Driver Containers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../driver-containers/overview.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Playground</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../playground/dind.html">Docker-in-Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../playground/x-arch.html">Running Cross-Architecture Containers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../contents.html">NVIDIA Cloud Native Technologies</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../contents.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../archive.html">Archive</a> &raquo;</li>
      <li>Appendix</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="appendix">
<span id="operator-appendix-22-9-1"></span><h1>Appendix<a class="headerlink" href="#appendix" title="Permalink to this heading"></a></h1>
<section id="install-gpu-operator-in-proxy-environments">
<span id="install-gpu-operator-22-9-1-proxy"></span><h2>Install GPU Operator in Proxy Environments<a class="headerlink" href="#install-gpu-operator-in-proxy-environments" title="Permalink to this heading"></a></h2>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h3>
<p>This page describes how to successfully deploy the GPU Operator in clusters behind a HTTP Proxy.
By default, the GPU Operator requires internet access for the following reasons:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Container images need to be pulled during GPU Operator installation.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">driver</span></code> container needs to download several OS packages prior to driver installation.</p></li>
</ol>
</div></blockquote>
<p>To address these requirements, all Kubernetes nodes as well as the <code class="docutils literal notranslate"><span class="pre">driver</span></code> container need proper configuration
in order to direct traffic through the proxy.</p>
<p>This document demonstrates how to configure the GPU Operator so that the <code class="docutils literal notranslate"><span class="pre">driver</span></code> container can successfully
download packages behind a HTTP proxy. Since configuring Kubernetes/container runtime components to use
a proxy is not specific to the GPU Operator, we do not include those instructions here.</p>
<p>The instructions for Openshift are different, so skip the section titled <a class="reference internal" href="install-gpu-operator-proxy.html#proxy-config-openshift-22-9-1"><span class="std std-ref">HTTP Proxy Configuration for Openshift</span></a> if you are not running Openshift.</p>
</section>
<section id="prerequisites">
<h3>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>Kubernetes cluster is configured with HTTP proxy settings (container runtime should be enabled with HTTP proxy)</p></li>
</ul>
</section>
<section id="http-proxy-configuration-for-openshift">
<span id="proxy-config-openshift-22-9-1"></span><h3>HTTP Proxy Configuration for Openshift<a class="headerlink" href="#http-proxy-configuration-for-openshift" title="Permalink to this heading"></a></h3>
<p>For Openshift, it is recommended to use the cluster-wide Proxy object to provide proxy information for the cluster.
Please follow the procedure described in <a class="reference external" href="https://docs.openshift.com/container-platform/4.8/networking/enable-cluster-wide-proxy.html">Configuring the cluster-wide proxy</a>
from Red Hat Openshift public documentation. The GPU Operator will automatically inject proxy related ENV into the <code class="docutils literal notranslate"><span class="pre">driver</span></code> container
based on information present in the cluster-wide Proxy object.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>GPU Operator v1.8.0 does not work well on RedHat OpenShift when a cluster-wide Proxy object is configured and causes constant restarts of <code class="docutils literal notranslate"><span class="pre">driver</span></code> container. This will be fixed in an upcoming patch release v1.8.2.</p></li>
</ul>
</div>
</section>
<section id="http-proxy-configuration">
<h3>HTTP Proxy Configuration<a class="headerlink" href="#http-proxy-configuration" title="Permalink to this heading"></a></h3>
<p>First, get the <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> file used for GPU Operator configuration:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>-sO<span class="w"> </span>https://raw.githubusercontent.com/NVIDIA/gpu-operator/v1.7.0/deployments/gpu-operator/values.yaml
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Replace <code class="docutils literal notranslate"><span class="pre">v1.7.0</span></code> in the above command with the version you want to use.</p>
</div>
<p>Specify <code class="docutils literal notranslate"><span class="pre">driver.env</span></code> in <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> with appropriate HTTP_PROXY, HTTPS_PROXY, and NO_PROXY environment variables
(in both uppercase and lowercase).</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">driver</span><span class="p">:</span>
<span class="w">   </span><span class="nt">env</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTPS_PROXY</span>
<span class="w">     </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://&lt;example.proxy.com:port&gt;</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTP_PROXY</span>
<span class="w">     </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://&lt;example.proxy.com:port&gt;</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NO_PROXY</span>
<span class="w">     </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;example.com&gt;</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https_proxy</span>
<span class="w">     </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://&lt;example.proxy.com:port&gt;</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http_proxy</span>
<span class="w">     </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://&lt;example.proxy.com:port&gt;</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no_proxy</span>
<span class="w">     </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;example.com&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>Proxy related ENV are automatically injected by GPU Operator into the <code class="docutils literal notranslate"><span class="pre">driver</span></code> container to indicate proxy information used when downloading necessary packages.</p></li>
<li><p>If HTTPS Proxy server is setup then change the values of HTTPS_PROXY and https_proxy to use <code class="docutils literal notranslate"><span class="pre">https</span></code> instead.</p></li>
</ul>
</div>
</section>
<section id="deploy-gpu-operator">
<h3>Deploy GPU Operator<a class="headerlink" href="#deploy-gpu-operator" title="Permalink to this heading"></a></h3>
<p>Download and deploy GPU Operator Helm Chart with the updated <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>.</p>
<p>Fetch the chart from NGC repository. <code class="docutils literal notranslate"><span class="pre">v1.10.0</span></code> is used as an example in the command below:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>helm<span class="w"> </span>fetch<span class="w"> </span>https://helm.ngc.nvidia.com/nvidia/charts/gpu-operator-v1.10.0.tgz
</pre></div>
</div>
<p>Install the GPU Operator with updated <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span>--wait<span class="w"> </span>gpu-operator<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-n<span class="w"> </span>gpu-operator<span class="w"> </span>--create-namespace<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>gpu-operator-v1.10.0.tgz<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-f<span class="w"> </span>values.yaml
</pre></div>
</div>
<p>Check the status of the pods to ensure all the containers are running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>gpu-operator
</pre></div>
</div>
</section>
</section>
<section id="install-gpu-operator-in-air-gapped-environments">
<span id="install-gpu-operator-22-9-1-air-gapped"></span><h2>Install GPU Operator in Air-gapped Environments<a class="headerlink" href="#install-gpu-operator-in-air-gapped-environments" title="Permalink to this heading"></a></h2>
<section id="id1">
<h3>Introduction<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<p>This page describes how to successfully deploy the GPU Operator in clusters with restricted internet access.
By default, The GPU Operator requires internet access for the following reasons:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Container images need to be pulled during GPU Operator installation.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">driver</span></code> container needs to download several OS packages prior to driver installation.</p></li>
</ol>
</div></blockquote>
<p>To address these requirements, it may be necessary to create a local image registry and/or a local package repository
so that the necessary images and packages are available for your cluster. In subsequent sections, we detail how to
configure the GPU Operator to use local image registries and local package repositories. If your cluster is behind
a proxy, also follow the steps from <a class="reference internal" href="install-gpu-operator-proxy.html#install-gpu-operator-22-9-1-proxy"><span class="std std-ref">Install GPU Operator in Proxy Environments</span></a>.</p>
<p>Different steps are required for different environments with varying levels of internet connectivity.
The supported use cases/environments are listed in the below table:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 12%" />
<col style="width: 26%" />
<col style="width: 31%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head" colspan="2"></th>
<th class="head" colspan="2"><p>Network Flow</p></th>
</tr>
<tr class="row-even"><th class="head" colspan="2"><p>Use Case</p></th>
<th class="head"><p>Pulling Images</p></th>
<th class="head"><p>Pulling Packages</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p><strong>1</strong></p></td>
<td><p>HTTP Proxy with
full Internet
access</p></td>
<td><p>K8s node –&gt; HTTP
Proxy –&gt; Internet
Image Registry</p></td>
<td><p>Driver container
–&gt; HTTP Proxy –&gt;
Internet Package
Repository</p></td>
</tr>
<tr class="row-even"><td><p><strong>2</strong></p></td>
<td><p>HTTP Proxy with
limited Internet
access</p></td>
<td><p>K8s node –&gt; HTTP
Proxy –&gt; Internet
Image Registry</p></td>
<td><p>Driver container
–&gt; HTTP Proxy –&gt;
Local Package
Repository</p></td>
</tr>
<tr class="row-odd"><td><p><strong>3a</strong></p></td>
<td><p>Full Air-Gapped
(w/ HTTP Proxy)</p></td>
<td><p>K8s node –&gt; Local
Image Registry</p></td>
<td><p>Driver container
–&gt; HTTP Proxy –&gt;
Local Package
Repository</p></td>
</tr>
<tr class="row-even"><td><p><strong>3b</strong></p></td>
<td><p>Full Air-Gapped
(w/o HTTP Proxy)</p></td>
<td><p>K8s node –&gt; Local
Image Registry</p></td>
<td><p>Driver container–&gt;
Local Package
Repository</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For Red Hat Openshift deployments in air-gapped environments (use cases 2, 3a and 3b), see the documentation <a class="reference external" href="https://docs.nvidia.com/datacenter/cloud-native/openshift/mirror-gpu-ocp-disconnected.html">here</a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ensure that Kubernetes nodes can successfully reach the local DNS server(s).
Public name resolution for image registry and package repositories are
mandatory for use cases 1 and 2.</p>
</div>
<p>Before proceeding to the next sections, get the <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> file used for GPU Operator configuration.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>-sO<span class="w"> </span>https://raw.githubusercontent.com/NVIDIA/gpu-operator/v1.7.0/deployments/gpu-operator/values.yaml
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Replace <code class="docutils literal notranslate"><span class="pre">v1.7.0</span></code> in the above command with the version you want to use.</p>
</div>
</section>
<section id="local-image-registry">
<h3>Local Image Registry<a class="headerlink" href="#local-image-registry" title="Permalink to this heading"></a></h3>
<p>Without internet access, the GPU Operator requires all images to be hosted in a local image registry that is accessible
to all nodes in the cluster. To allow the GPU Operator to work with a local registry, users can specify local
repository, image, tag along with pull secrets in <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>.</p>
<section id="pulling-and-pushing-container-images-to-local-registry">
<h4>Pulling and pushing container images to local registry<a class="headerlink" href="#pulling-and-pushing-container-images-to-local-registry" title="Permalink to this heading"></a></h4>
<p>To pull the correct images from the NVIDIA registry, you can leverage the fields <code class="docutils literal notranslate"><span class="pre">repository</span></code>, <code class="docutils literal notranslate"><span class="pre">image</span></code> and <code class="docutils literal notranslate"><span class="pre">version</span></code>
specified in the file <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>.</p>
<p>The general syntax for the container image is <code class="docutils literal notranslate"><span class="pre">&lt;repository&gt;/&lt;image&gt;:&lt;version&gt;</span></code>.</p>
<p>If the version is not specified, you can retrieve the information from the NVIDIA NGC catalog (<a class="reference external" href="https://ngc.nvidia.com/catalog">https://ngc.nvidia.com/catalog</a>)
by checking the available tags for an image.</p>
<p>An example is shown below with the gpu-operator container image:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">operator</span><span class="p">:</span>
<span class="w">    </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvcr.io/nvidia</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gpu-operator</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;v1.9.0&quot;</span>
</pre></div>
</div>
<p>For instance, to pull the gpu-operator image version v1.9.0, use the following instruction:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>pull<span class="w"> </span>nvcr.io/nvidia/gpu-operator:v1.9.0
</pre></div>
</div>
<p>There is one caveat with regards to the driver image. The version field must be appended by the OS name running on the worker node.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">driver</span><span class="p">:</span>
<span class="w">    </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvcr.io/nvidia</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">driver</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;470.82.01&quot;</span>
</pre></div>
</div>
<p>To pull the driver image for Ubuntu 20.04:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>pull<span class="w"> </span>nvcr.io/nvidia/driver:470.82.01-ubuntu20.04
</pre></div>
</div>
<p>To pull the driver image for CentOS 8:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>pull<span class="w"> </span>nvcr.io/nvidia/driver:470.82.01-centos8
</pre></div>
</div>
<p>To push the images to the local registry, simply tag the pulled images by prefixing the image with the image registry information.</p>
<p>Using the above examples, this will result in:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>tag<span class="w"> </span>nvcr.io/nvidia/gpu-operator:v1.9.0<span class="w"> </span>&lt;local-registry&gt;/&lt;local-path&gt;/gpu-operator:v1.9.0
<span class="gp">$ </span>docker<span class="w"> </span>tag<span class="w"> </span>nvcr.io/nvidia/driver:470.82.01-ubuntu20.04<span class="w"> </span>&lt;local-registry&gt;/&lt;local-path&gt;/driver:470.82.01-ubuntu20.04
</pre></div>
</div>
<p>Finally, push the images to the local registry:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>push<span class="w">  </span>&lt;local-registry&gt;/&lt;local-path&gt;/gpu-operator:v1.9.0
<span class="gp">$ </span>docker<span class="w"> </span>push<span class="w"> </span>&lt;local-registry&gt;/&lt;local-path&gt;/driver:470.82.01-ubuntu20.04
</pre></div>
</div>
<p>Update <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> with local registry information in the repository field.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>replace &lt;repo.example.com:port&gt; below with your local image registry url and port</p>
</div>
<p>Sample of <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> for GPU Operator v1.9.0:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">operator</span><span class="p">:</span>
<span class="w">  </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;repo.example.com:port&gt;</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gpu-operator</span>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.9.0</span>
<span class="w">  </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">  </span><span class="nt">initContainer</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cuda</span>
<span class="w">    </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;repo.example.com:port&gt;</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">11.4.2-base-ubi8</span>

<span class="w w-Error"> </span><span class="nt">validator</span><span class="p">:</span>
<span class="w">   </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gpu-operator-validator</span>
<span class="w">   </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;repo.example.com:port&gt;</span>
<span class="w">   </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.9.0</span>
<span class="w">   </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>

<span class="w"> </span><span class="nt">driver</span><span class="p">:</span>
<span class="w">   </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;repo.example.com:port&gt;</span>
<span class="w">   </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">driver</span>
<span class="w">   </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;470.82.01&quot;</span>
<span class="w">   </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">   </span><span class="nt">manager</span><span class="p">:</span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-driver-manager</span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;repo.example.com:port&gt;</span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.2.0</span>

<span class="w"> </span><span class="nt">toolkit</span><span class="p">:</span>
<span class="w">   </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;repo.example.com:port&gt;</span>
<span class="w">   </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">container-toolkit</span>
<span class="w">   </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.7.2-ubuntu18.04</span>
<span class="w">   </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>

<span class="w"> </span><span class="nt">devicePlugin</span><span class="p">:</span>
<span class="w">   </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;repo.example.com:port&gt;</span>
<span class="w">   </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-device-plugin</span>
<span class="w">   </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.10.0-ubi8</span>
<span class="w">   </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>

<span class="w"> </span><span class="nt">dcgmExporter</span><span class="p">:</span>
<span class="w">   </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;repo.example.com:port&gt;</span>
<span class="w">   </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dcgm-exporter</span>
<span class="w">   </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.3.1-2.6.0-ubuntu20.04</span>
<span class="w">   </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>

<span class="w"> </span><span class="nt">gfd</span><span class="p">:</span>
<span class="w">   </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;repo.example.com:port&gt;</span>
<span class="w">   </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gpu-feature-discovery</span>
<span class="w">   </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.4.1</span>
<span class="w">   </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>

<span class="w"> </span><span class="nt">nodeStatusExporter</span><span class="p">:</span>
<span class="w">   </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">   </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;repo.example.com:port&gt;</span>
<span class="w">   </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gpu-operator-validator</span>
<span class="w">   </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.9.0&quot;</span>

<span class="w"> </span><span class="nt">migManager</span><span class="p">:</span>
<span class="w">   </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">   </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;repo.example.com:port&gt;</span>
<span class="w">   </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-mig-manager</span>
<span class="w">   </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.2.0-ubuntu20.04</span>

<span class="w"> </span><span class="nt">node-feature-discovery</span><span class="p">:</span>
<span class="w">   </span><span class="nt">image</span><span class="p">:</span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;repo.example.com:port&gt;</span>
<span class="w">     </span><span class="nt">pullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
<span class="w">     </span><span class="c1"># tag, if defined will use the given image tag, else Chart.AppVersion will be used</span>
<span class="w">     </span><span class="c1"># tag:</span>
<span class="w">   </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
</pre></div>
</div>
</section>
</section>
<section id="local-package-repository">
<h3>Local Package Repository<a class="headerlink" href="#local-package-repository" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">driver</span></code> container deployed as part of the GPU operator requires certain packages to be available as part of the
driver installation. In restricted internet access or air-gapped installations, users are required to create a
local mirror repository for their OS distribution and make the following packages available:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>KERNEL_VERSION is the underlying running kernel version on the GPU node
GCC_VERSION is the gcc version matching the one used for building underlying kernel</p>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">ubuntu</span><span class="p">:</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">linux-headers-${KERNEL_VERSION}</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">linux-image-${KERNEL_VERSION}</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">linux-modules-${KERNEL_VERSION}</span>

<span class="nt">centos</span><span class="p">:</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">elfutils-libelf.x86_64</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">elfutils-libelf-devel.x86_64</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">kernel-headers-${KERNEL_VERSION}</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">kernel-devel-${KERNEL_VERSION}</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">kernel-core-${KERNEL_VERSION}</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">gcc-${GCC_VERSION}</span>

<span class="nt">rhel/rhcos</span><span class="p">:</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">kernel-headers-${KERNEL_VERSION}</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">kernel-devel-${KERNEL_VERSION}</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">kernel-core-${KERNEL_VERSION}</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">gcc-${GCC_VERSION}</span>
</pre></div>
</div>
<p>For example, for Ubuntu these packages can be found at <code class="docutils literal notranslate"><span class="pre">archive.ubuntu.com</span></code> so this would be the mirror that
needs to be replicated locally for your cluster. Using <code class="docutils literal notranslate"><span class="pre">apt-mirror</span></code>, these packages will be automatically mirrored
to your local package repository server.</p>
<p>For CentOS, <code class="docutils literal notranslate"><span class="pre">reposync</span></code> can be used to create the local mirror.</p>
<p>Once all above required packages are mirrored to the local repository, repo lists need to be created following
distribution specific documentation. A <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code> containing the repo list file needs to be created in
the namespace where the GPU Operator gets deployed.</p>
<p>An example of repo list is shown below for Ubuntu 20.04 (access to local package repository via HTTP):</p>
<p><code class="docutils literal notranslate"><span class="pre">custom-repo.list</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">deb</span> <span class="p">[</span><span class="n">arch</span><span class="o">=</span><span class="n">amd64</span><span class="p">]</span> <span class="n">http</span><span class="p">:</span><span class="o">//&lt;</span><span class="n">local</span> <span class="n">pkg</span> <span class="n">repository</span><span class="o">&gt;/</span><span class="n">ubuntu</span><span class="o">/</span><span class="n">mirror</span><span class="o">/</span><span class="n">archive</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span> <span class="n">focal</span> <span class="n">main</span> <span class="n">universe</span>
<span class="n">deb</span> <span class="p">[</span><span class="n">arch</span><span class="o">=</span><span class="n">amd64</span><span class="p">]</span> <span class="n">http</span><span class="p">:</span><span class="o">//&lt;</span><span class="n">local</span> <span class="n">pkg</span> <span class="n">repository</span><span class="o">&gt;/</span><span class="n">ubuntu</span><span class="o">/</span><span class="n">mirror</span><span class="o">/</span><span class="n">archive</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span> <span class="n">focal</span><span class="o">-</span><span class="n">updates</span> <span class="n">main</span> <span class="n">universe</span>
<span class="n">deb</span> <span class="p">[</span><span class="n">arch</span><span class="o">=</span><span class="n">amd64</span><span class="p">]</span> <span class="n">http</span><span class="p">:</span><span class="o">//&lt;</span><span class="n">local</span> <span class="n">pkg</span> <span class="n">repository</span><span class="o">&gt;/</span><span class="n">ubuntu</span><span class="o">/</span><span class="n">mirror</span><span class="o">/</span><span class="n">archive</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span> <span class="n">focal</span><span class="o">-</span><span class="n">security</span> <span class="n">main</span> <span class="n">universe</span>
</pre></div>
</div>
<p>An example of repo list is shown below for CentOS 8 (access to local package repository via HTTP):</p>
<p><code class="docutils literal notranslate"><span class="pre">custom-repo.repo</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[baseos]
name=CentOS Linux $releasever - BaseOS
baseurl=http://&lt;local pkg repository&gt;/repos/centos/$releasever/$basearch/os/baseos/
gpgcheck=0
enabled=1

[appstream]
name=CentOS Linux $releasever - AppStream
baseurl=http://&lt;local pkg repository&gt;/repos/centos/$releasever/$basearch/os/appstream/
gpgcheck=0
enabled=1

[extras]
name=CentOS Linux $releasever - Extras
baseurl=http://&lt;local pkg repository&gt;/repos/centos/$releasever/$basearch/os/extras/
gpgcheck=0
enabled=1
</pre></div>
</div>
<p>Create the <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>create<span class="w"> </span>configmap<span class="w"> </span>repo-config<span class="w"> </span>-n<span class="w"> </span>gpu-operator<span class="w"> </span>--from-file<span class="o">=</span>&lt;path-to-repo-list-file&gt;
</pre></div>
</div>
<p>Once the ConfigMap is created using the above command, update <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> with this information, to let the GPU Operator mount the repo configuration
within the <code class="docutils literal notranslate"><span class="pre">driver</span></code> container to pull required packages. Based on the OS distribution the GPU Operator will automatically mount this ConfigMap into the appropriate directory.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">driver</span><span class="p">:</span>
<span class="w">   </span><span class="nt">repoConfig</span><span class="p">:</span>
<span class="w">      </span><span class="nt">configMapName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">repo-config</span>
</pre></div>
</div>
<p>If self-signed certificates are used for an HTTPS based internal repository then a ConfigMap needs to be created for those certs and provide that during the GPU Operator
install. Based on the OS distribution the GPU Operator will automatically mount this ConfigMap into the appropriate directory.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>create<span class="w"> </span>configmap<span class="w"> </span>cert-config<span class="w"> </span>-n<span class="w"> </span>gpu-operator<span class="w"> </span>--from-file<span class="o">=</span>&lt;path-to-pem-file1&gt;<span class="w"> </span>--from-file<span class="o">=</span>&lt;path-to-pem-file2&gt;
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">driver</span><span class="p">:</span>
<span class="w">   </span><span class="nt">certConfig</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-config</span>
</pre></div>
</div>
</section>
<section id="id2">
<h3>Deploy GPU Operator<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h3>
<p>Download and deploy GPU Operator Helm Chart with the updated <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>.</p>
<p>Fetch the chart from NGC repository. <code class="docutils literal notranslate"><span class="pre">v1.9.0</span></code> is used in the command below:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>helm<span class="w"> </span>fetch<span class="w"> </span>https://helm.ngc.nvidia.com/nvidia/charts/gpu-operator-v1.9.0.tgz
</pre></div>
</div>
<p>Install the GPU Operator with updated <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span>--wait<span class="w"> </span>gpu-operator<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-n<span class="w"> </span>gpu-operator<span class="w"> </span>--create-namespace<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>gpu-operator-v1.9.0.tgz<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-f<span class="w"> </span>values.yaml
</pre></div>
</div>
<p>Check the status of the pods to ensure all the containers are running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>gpu-operator
</pre></div>
</div>
</section>
</section>
<section id="considerations-when-installing-with-outdated-kernels-in-cluster">
<span id="install-gpu-operator-22-9-1-outdated-kernels"></span><h2>Considerations when Installing with Outdated Kernels in Cluster<a class="headerlink" href="#considerations-when-installing-with-outdated-kernels-in-cluster" title="Permalink to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">driver</span></code> container deployed as part of the GPU Operator requires certain packages to be available as part of the driver installation.
On GPU nodes where the running kernel is not the latest, the <code class="docutils literal notranslate"><span class="pre">driver</span></code> container may fail to find the right version of these packages
(e.g. kernel-headers, kernel-devel) that correspond to the running kernel version. In the <code class="docutils literal notranslate"><span class="pre">driver</span></code> container logs, you will most likely
see the following error message: <code class="docutils literal notranslate"><span class="pre">Could</span> <span class="pre">not</span> <span class="pre">resolve</span> <span class="pre">Linux</span> <span class="pre">kernel</span> <span class="pre">version</span></code>.</p>
<p>In general, upgrading your system to the latest kernel should fix this issue. But if this is not an option, the following is a
workaround to successfully deploy the GPU operator when GPU nodes in your cluster may not be running the latest kernel.</p>
<section id="add-archived-package-repositories">
<h3>Add Archived Package Repositories<a class="headerlink" href="#add-archived-package-repositories" title="Permalink to this heading"></a></h3>
<p>The workaround is to find the package archive containing packages for your outdated kernel and to add this repository to the package
manager running inside the <code class="docutils literal notranslate"><span class="pre">driver</span></code> container. To achieve this, we can simply mount a repository list file into the <code class="docutils literal notranslate"><span class="pre">driver</span></code> container using a <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code>.
The <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code> containing the repository list file needs to be created in the <code class="docutils literal notranslate"><span class="pre">gpu-operator</span></code> namespace.</p>
<p>Let us demonstrate this workaround via an example. The system used in this example is running CentOS 7 with an outdated kernel:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>uname<span class="w"> </span>-r
<span class="go">3.10.0-1062.12.1.el7.x86_64</span>
</pre></div>
</div>
<p>The official archive for older CentOS packages is <a class="reference external" href="https://vault.centos.org/">https://vault.centos.org/</a>. Typically, most archived CentOS repositories
are found in <code class="docutils literal notranslate"><span class="pre">/etc/yum.repos.d/CentOS-Vault.repo</span></code> but they are disabled by default. If the appropriate archive repository
was enabled, then the <code class="docutils literal notranslate"><span class="pre">driver</span></code> container would resolve the kernel version and be able to install the correct versions
of the prerequisite packages.</p>
<p>We can simply drop in a replacement of <code class="docutils literal notranslate"><span class="pre">/etc/yum.repos.d/CentOS-Vault.repo</span></code> to ensure the appropriate CentOS archive is enabled.
For the kernel running in this example, the <code class="docutils literal notranslate"><span class="pre">CentOS-7.7.1908</span></code> archive contains the kernel-headers version we are looking for.
Here is our example drop-in replacement file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[C7.7.1908-base]
name=CentOS-7.7.1908 - Base
baseurl=http://vault.centos.org/7.7.1908/os/$basearch/
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
enabled=1

[C7.7.1908-updates]
name=CentOS-7.7.1908 - Updates
baseurl=http://vault.centos.org/7.7.1908/updates/$basearch/
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
enabled=1
</pre></div>
</div>
<p>Once the repo list file is created, we can create a <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code> for it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>create<span class="w"> </span>configmap<span class="w"> </span>repo-config<span class="w"> </span>-n<span class="w"> </span>gpu-operator<span class="w"> </span>--from-file<span class="o">=</span>&lt;path-to-repo-list-file&gt;
</pre></div>
</div>
<p>Once the <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code> is created using the above command, update <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> with this information, to let the GPU Operator mount the repo configuration
within the <code class="docutils literal notranslate"><span class="pre">driver</span></code> container to pull required packages.</p>
<p>For Ubuntu:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">driver</span><span class="p">:</span>
<span class="w">   </span><span class="nt">repoConfig</span><span class="p">:</span>
<span class="w">      </span><span class="nt">configMapName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">repo-config</span>
<span class="w">      </span><span class="nt">destinationDir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/apt/sources.list.d</span>
</pre></div>
</div>
<p>For RHEL/Centos/RHCOS:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">driver</span><span class="p">:</span>
<span class="w">   </span><span class="nt">repoConfig</span><span class="p">:</span>
<span class="w">      </span><span class="nt">configMapName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">repo-config</span>
<span class="w">      </span><span class="nt">destinationDir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/yum.repos.d</span>
</pre></div>
</div>
<p>Deploy GPU Operator with updated <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span>--wait<span class="w"> </span>--generate-name<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-n<span class="w"> </span>gpu-operator<span class="w"> </span>--create-namespace<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>nvidia/gpu-operator<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-f<span class="w"> </span>values.yaml
</pre></div>
</div>
<p>Check the status of the pods to ensure all the containers are running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>gpu-operator
</pre></div>
</div>
</section>
</section>
<section id="customizing-nvidia-gpu-driver-parameters-during-installation">
<h2>Customizing NVIDIA GPU Driver Parameters during Installation<a class="headerlink" href="#customizing-nvidia-gpu-driver-parameters-during-installation" title="Permalink to this heading"></a></h2>
<p>The NVIDIA Driver kernel modules accept a number of parameters which can be used to customize the behavior of the driver.
Most of the parameters are documented in the <a class="reference external" href="https://download.nvidia.com/XFree86/Linux-x86_64/510.47.03/README/">NVIDIA Driver README</a>.
By default, the GPU Operator loads the kernel modules with default values.
Starting with v1.10, the GPU Operator provides the ability to pass custom parameters to the kernel modules that get loaded as part of the
NVIDIA Driver installation (e.g. <code class="docutils literal notranslate"><span class="pre">nvidia</span></code>, <code class="docutils literal notranslate"><span class="pre">nvidia-modeset</span></code>, <code class="docutils literal notranslate"><span class="pre">nvidia-uvm</span></code>, and <code class="docutils literal notranslate"><span class="pre">nvidia-peermem</span></code>).</p>
<p>To pass custom parameters, execute the following steps.</p>
<p>Create a configuration file named <code class="docutils literal notranslate"><span class="pre">&lt;module&gt;.conf</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;module&gt;</span></code> is the name of the kernel module the parameters are for.
The file should contain parameters as key-value pairs – one parameter per line.
In the below example, we are passing one parameter to the <code class="docutils literal notranslate"><span class="pre">nvidia</span></code> module, which is disabling the use of
<a class="reference external" href="https://download.nvidia.com/XFree86/Linux-x86_64/510.47.03/README/gsp.html">GSP firmware</a>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>nvidia.conf
<span class="go">NVreg_EnableGpuFirmware=0</span>
</pre></div>
</div>
<p>Create a <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code> for the configuration file.
If multiple modules are being configured, pass multiple files when creating the <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>create<span class="w"> </span>configmap<span class="w"> </span>kernel-module-params<span class="w"> </span>-n<span class="w"> </span>gpu-operator<span class="w"> </span>--from-file<span class="o">=</span>nvidia.conf<span class="o">=</span>./nvidia.conf
</pre></div>
</div>
<p>Install the GPU Operator and set <code class="docutils literal notranslate"><span class="pre">driver.kernelModuleConfig.name</span></code> to the name of the <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code>
containing the kernel module parameters.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span>--wait<span class="w"> </span>--generate-name<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-n<span class="w"> </span>gpu-operator<span class="w"> </span>--create-namespace<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>nvidia/gpu-operator<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>--set<span class="w"> </span>driver.kernelModuleConfig.name<span class="o">=</span><span class="s2">&quot;kernel-module-params&quot;</span>
</pre></div>
</div>
</section>
<section id="installing-precompiled-and-canonical-signed-drivers-on-ubuntu-20-04-and-22-04">
<span id="install-precompiled-signed-drivers-22-9-1"></span><h2>Installing Precompiled and Canonical Signed Drivers on Ubuntu 20.04 and 22.04<a class="headerlink" href="#installing-precompiled-and-canonical-signed-drivers-on-ubuntu-20-04-and-22-04" title="Permalink to this heading"></a></h2>
<p>GPU Operator supports deploying NVIDIA precompiled and signed drivers from Canonical on Ubuntu 20.04 and 22.04 (x86 platform only). This is required
when nodes are enabled with Secure Boot. In order to use these, GPU Operator needs to be installed with options <code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">driver.version=&lt;DRIVER_BRANCH&gt;-signed</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>helm<span class="w"> </span>install<span class="w"> </span>--wait<span class="w"> </span>gpu-operator<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-n<span class="w"> </span>gpu-operator<span class="w"> </span>--create-namespace<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>nvidia/gpu-operator<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>--set<span class="w"> </span>driver.version<span class="o">=</span>&lt;DRIVER_BRANCH&gt;-signed
</pre></div>
</div>
<p>supported DRIVER_BRANCH value currently are <code class="docutils literal notranslate"><span class="pre">470</span></code>, <code class="docutils literal notranslate"><span class="pre">510</span></code> and <code class="docutils literal notranslate"><span class="pre">515</span></code> which will install latest drivers available on that branch for current running
kernel version.</p>
<p>Following are the packages used in this case by the driver container.</p>
<ul class="simple">
<li><p>linux-objects-nvidia-${DRIVER_BRANCH}-server-${KERNEL_VERSION} - Linux kernel nvidia modules.</p></li>
<li><p>linux-signatures-nvidia-${KERNEL_VERSION} - Linux kernel signatures for nvidia modules.</p></li>
<li><p>linux-modules-nvidia-${DRIVER_BRANCH}-server-${KERNEL_VERSION} - Meta package for nvidia driver modules, signatures and kernel interfaces.</p></li>
<li><p>nvidia-utils-${DRIVER_BRANCH}-server - NVIDIA driver support binaries.</p></li>
<li><p>nvidia-compute-utils-${DRIVER_BRANCH}-server - NVIDIA compute utilities (includes nvidia-persistenced).</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>Before upgrading kernel on the worker nodes please ensure that above packages are available for that kernel version, else upgrade will
cause driver installation failures.</p></li>
</ul>
</div>
<p>To check if above packages are available for a specific kernel version, use the following commands (in this example, we use the 515 branch):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nv">KERNEL_VERSION</span><span class="o">=</span><span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span>
<span class="gp">$ </span><span class="nv">DRIVER_BRANCH</span><span class="o">=</span><span class="m">515</span>
<span class="gp">$ </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
<span class="gp">$ </span>sudo<span class="w"> </span>apt-cache<span class="w"> </span>show<span class="w"> </span>linux-modules-nvidia-<span class="si">${</span><span class="nv">DRIVER_BRANCH</span><span class="si">}</span>-server-<span class="si">${</span><span class="nv">KERNEL_VERSION</span><span class="si">}</span>
</pre></div>
</div>
<p>A successful output is shown below:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>apt-cache<span class="w"> </span>show<span class="w"> </span>linux-modules-nvidia-<span class="si">${</span><span class="nv">DRIVER_BRANCH</span><span class="si">}</span>-server-<span class="si">${</span><span class="nv">KERNEL_VERSION</span><span class="si">}</span>

<span class="go">Package: linux-modules-nvidia-515-server-5.15.0-56-generic</span>
<span class="go">Architecture: amd64</span>
<span class="go">Version: 5.15.0-56.62+1</span>
<span class="go">Priority: optional</span>
<span class="go">Section: restricted/kernel</span>
<span class="go">Source: linux-restricted-modules</span>
<span class="go">Origin: Ubuntu</span>
<span class="go">Maintainer: Canonical Kernel Team &lt;kernel-team@lists.ubuntu.com&gt;</span>
<span class="go">Bugs: https://bugs.launchpad.net/ubuntu/+filebug</span>
<span class="go">Installed-Size: 34</span>
<span class="go">Depends: debconf (&gt;= 0.5) | debconf-2.0, linux-image-5.15.0-56-generic | linux-image-unsigned-5.15.0-56-generic, linux-signatures-nvidia-5.15.0-56-generic  (= 5.15.0-56.62+1), linux-objects-nvidia-515-server-5.15.0-56-generic (= 5.15.0-56.62+1), nvidia-kernel-common-515-server (&lt;= 515.86.01-1), nvidia-kernel-common-515-server (&gt;= 515.86.01)</span>
<span class="go">Filename: pool/restricted/l/linux-restricted-modules/linux-modules-nvidia-515-server-5.15.0-56-generic_5.15.0-56.62+1_amd64.deb</span>
<span class="go">Size: 7040</span>
<span class="go">MD5sum: 530d817653545eaac63ec64d6edc115c</span>
<span class="go">SHA1: e2fd492c06a9be7d0a603d6861d7e35a267d2943</span>
<span class="go">SHA256: 999477c5bd0b213196ed93fd6340a0183dc3d8202be2aa5a008d50f3ba184a3a</span>
<span class="go">SHA512: 45b2bd3f377449742c92b5f7c89c09540edd3e5162cc8d87e3a2c5c45939595c9972982a1ff4e520a56b1525b9f208a2b791619f028f6b420faec0892c430632</span>
<span class="go">Description-en: Linux kernel nvidia modules for version 5.15.0-56</span>
<span class="go">This package pulls together the Linux kernel nvidia modules for</span>
<span class="go">version 5.15.0-56 with the appropriate signatures.</span>
<span class="go">.</span>
<span class="go">You likely do not want to install this package directly. Instead, install the</span>
<span class="go">one of the linux-modules-nvidia-515-server-generic* meta-packages,</span>
<span class="go">which will ensure that upgrades work correctly, and that supporting packages are</span>
<span class="go">also installed.</span>
<span class="go">Description-md5: 13391e5f98aed1dde0d387f22d097bed</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="gpu-operator-kubevirt.html" class="btn btn-neutral float-left" title="GPU Operator with KubeVirt" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../22.9.0/overview.html" class="btn btn-neutral float-right" title="Overview" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2023, NVIDIA Corporation.
      <span class="lastupdated">Last updated on 2023-03-13.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
  a:link, a:visited {
    color: #76b900;
  }

  a:hover {
    color: #8c0;
  }

  .rst-content dl:not(.docutils) dt {
    background: rgba(118, 185, 0, 0.1);
    color: rgba(59,93,0,1);
    border-top: solid 3px rgba(59,93,0,1);
  }
  </style>
  

</body>
</html>